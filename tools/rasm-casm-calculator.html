
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RASM / CASM / Yield & Break-Even LF Calculator | Airline Metrics Tool</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="Compute RASM, PRASM, CASM, Yield, break-even load factor, passenger revenue and contribution instantly from ASMs, RPMs, revenues and costs. Scenario sliders, charts and multi-currency support.">
<meta name="theme-color" content="#0d1b2a">
<link rel="canonical" href="https://your-domain.example/tools/rasm-casm-calculator.html">
<meta property="og:title" content="RASM / CASM / Yield Calculator">
<meta property="og:description" content="Instantly derive RASM, CASM, Yield & break-even load factor from your inputs with scenario sliders & charts.">
<meta property="og:type" content="website">
<meta property="og:image" content="https://your-domain.example/assets/og-banner.jpg">
<style>
:root{
  --clr-bg:#0d1b2a;
  --clr-bg-alt:#132235;
  --clr-accent:#3298dc;
  --clr-accent-alt:#4fb1f5;
  --clr-text:#e8f0f7;
  --clr-text-dim:#9fb3c5;
  --radius:14px;
  --transition:.28s cubic-bezier(.4,.2,.2,1);
  --focus-ring:0 0 0 3px rgba(50,152,220,.55);
  --danger:#e45050;
  --success:#35b376;
  --warn:#e6b34c;
  --surface:linear-gradient(165deg,rgba(255,255,255,.05),rgba(255,255,255,.015));
  --surface-strong:linear-gradient(150deg,rgba(255,255,255,.09),rgba(255,255,255,.02));
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:linear-gradient(to bottom,var(--clr-bg),var(--clr-bg-alt));
  color:var(--clr-text);
  min-height:100vh;
}
header.topbar{
  position:fixed;
  inset:0 0 auto 0;
  background:rgba(13,27,42,.72);
  backdrop-filter:blur(14px) saturate(1.3);
  display:flex;
  align-items:center;
  gap:.9rem;
  padding:.65rem 1rem;
  z-index:100;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.brand{
  font-weight:600;
  letter-spacing:.6px;
  font-size:.9rem;
  display:flex;
  align-items:center;
  gap:.45rem;
  text-decoration:none;
  color:var(--clr-text);
}
.brand span.logo{
  background:linear-gradient(135deg,#fff,#82bfe7);
  -webkit-background-clip:text;
  color:transparent;
  font-weight:700;
  font-size:1.05rem;
}
.currency-select{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:.4rem;
  font-size:.7rem;
  color:var(--clr-text-dim);
  text-transform:uppercase;
  letter-spacing:.6px;
}
.currency-select select{
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.25);
  color:var(--clr-text);
  padding:.35rem .55rem;
  border-radius:8px;
  font-size:.75rem;
  cursor:pointer;
}
.currency-select select:focus{outline:none;box-shadow:var(--focus-ring);}
nav a.home-btn{
  background:linear-gradient(135deg,var(--clr-accent),var(--clr-accent-alt));
  color:#fff;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:40px;
  height:40px;
  border-radius:12px;
  font-size:1.1rem;
  font-weight:600;
  box-shadow:0 6px 14px -4px rgba(0,0,0,.5);
  transition:var(--transition);
}
nav a.home-btn:hover{transform:translateY(-3px);}
nav a.home-btn:focus{outline:none;box-shadow:var(--focus-ring);}
main{
  max-width:1400px;
  margin:0 auto;
  padding:5.8rem 1.2rem 4rem;
}
h1{
  font-size:clamp(2.1rem,5vw,3rem);
  margin:0 0 .7rem;
  font-weight:700;
  background:linear-gradient(90deg,#fff,#c6d9e8 45%,#82bfe7);
  -webkit-background-clip:text;
  color:transparent;
}
.lede{
  max-width:880px;
  font-size:1.05rem;
  color:var(--clr-text-dim);
  line-height:1.5;
  margin:0 0 2rem;
}
.notice-inline{
  font-size:.63rem;
  letter-spacing:.5px;
  text-transform:uppercase;
  font-weight:600;
  background:rgba(255,255,255,.09);
  padding:.4rem .65rem;
  border-radius:999px;
  display:inline-block;
  margin-bottom:1.1rem;
  color:var(--clr-text-dim);
}
.grid{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:2rem;
  align-items:start;
}
@media(max-width:1250px){
  .grid{grid-template-columns:340px 1fr;}
}
@media(max-width:1050px){
  .grid{grid-template-columns:1fr;}
}
.card{
  background:var(--surface);
  border:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(12px);
  border-radius:var(--radius);
  padding:1.4rem 1.3rem 1.6rem;
  transition:var(--transition);
  position:relative;
}
.card:hover{
  border-color:rgba(255,255,255,.15);
}
.card h2{
  margin:.1rem 0 1rem;
  font-size:1rem;
  font-weight:600;
  letter-spacing:.4px;
  display:flex;
  align-items:center;
  gap:.55rem;
  color:#fff;
}
label{
  display:flex;
  justify-content:space-between;
  font-size:.64rem;
  font-weight:600;
  letter-spacing:.55px;
  text-transform:uppercase;
  color:var(--clr-text-dim);
  margin-bottom:.35rem;
}
input[type=number]{
  width:100%;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.18);
  border-radius:10px;
  padding:.65rem .8rem;
  color:var(--clr-text);
  font-size:.9rem;
  transition:var(--transition);
  -moz-appearance:textfield;
}
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
input[type=number]:focus{
  outline:none;
  box-shadow:var(--focus-ring);
  border-color:var(--clr-accent-alt);
  background:rgba(255,255,255,.12);
}
.field{margin-bottom:.9rem;}
.metric-box{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:.9rem;
  margin-top:.5rem;
}
.metric{
  background:var(--surface-strong);
  border:1px solid rgba(255,255,255,.1);
  padding:.85rem .9rem .95rem;
  border-radius:12px;
  position:relative;
  overflow:hidden;
  transition:var(--transition);
}
.metric:hover{border-color:rgba(255,255,255,.2);}
.metric h3{
  margin:0 0 .35rem;
  font-size:.58rem;
  letter-spacing:.55px;
  text-transform:uppercase;
  font-weight:700;
  color:var(--clr-text-dim);
}
.metric .val{
  font-size:1.05rem;
  font-weight:600;
  letter-spacing:.4px;
  display:flex;
  align-items:baseline;
  gap:.35rem;
  flex-wrap:wrap;
}
small.note{
  display:block;
  font-size:.6rem;
  color:var(--clr-text-dim);
  margin-top:.3rem;
  line-height:1.25;
}
.status{
  font-size:.65rem;
  letter-spacing:.55px;
  text-transform:uppercase;
  font-weight:600;
  color:var(--clr-text-dim);
  min-height:1rem;
  margin-top:.2rem;
}
.share-btn{
  margin-top:.8rem;
  background:linear-gradient(135deg,var(--clr-accent),var(--clr-accent-alt));
  border:none;
  border-radius:999px;
  padding:.55rem .95rem;
  font-size:.62rem;
  letter-spacing:.55px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
  transition:var(--transition);
}
.share-btn:hover{transform:translateY(-3px);}
.share-btn:focus{outline:none;box-shadow:var(--focus-ring);}
.share-btn.copied{background:linear-gradient(135deg,#3bb273,#66d69b);}
.range-field{margin-bottom:1.1rem;}
.range-field label{margin-bottom:.4rem;}
input[type=range]{
  width:100%;
  appearance:none;
  height:8px;
  border-radius:6px;
  background:linear-gradient(90deg,var(--clr-accent),var(--clr-accent-alt));
  outline:none;
  cursor:pointer;
  opacity:.9;
  transition:opacity .3s;
}
input[type=range]:hover{opacity:1;}
input[type=range]::-webkit-slider-thumb{
  appearance:none;
  width:22px;
  height:22px;
  border-radius:50%;
  background:#fff;
  border:3px solid var(--clr-accent);
  box-shadow:0 2px 8px -2px rgba(0,0,0,.6);
  transition:var(--transition);
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.1);}
.slider-val{
  font-weight:600;
  color:#fff;
  font-size:.7rem;
  letter-spacing:.4px;
  background:rgba(255,255,255,.12);
  padding:.25rem .55rem;
  border-radius:8px;
}
.divider{
  height:1px;
  background:linear-gradient(90deg,rgba(255,255,255,.05),rgba(255,255,255,.25),rgba(255,255,255,.05));
  margin:1.2rem 0 1.1rem;
  border:none;
}
.charts-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:1.2rem;
  margin-top:.9rem;
}
.chart-box{
  position:relative;
  background:var(--surface-strong);
  border:1px solid rgba(255,255,255,.1);
  padding:.9rem .85rem 1rem;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  gap:.4rem;
  min-height:250px;
}
.chart-box h3{
  margin:0;
  font-size:.62rem;
  letter-spacing:.55px;
  text-transform:uppercase;
  font-weight:700;
  color:var(--clr-text-dim);
  display:flex;
  align-items:center;
  gap:.4rem;
}
.chart-fallback{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.65rem;
  color:var(--clr-text-dim);
  padding:0 .8rem;
  text-align:center;
  pointer-events:none;
}
canvas{width:100% !important;height:180px !important;}
@media(max-width:750px){canvas{height:200px !important;}}
.badge{display:inline-flex;align-items:center;gap:.3rem;background:rgba(255,255,255,.08);padding:.35rem .55rem;border-radius:9px;font-size:.55rem;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--clr-text-dim);}
.footer{
  max-width:1400px;
  margin:2.5rem auto 2rem;
  padding:0 1.2rem;
  font-size:.6rem;
  letter-spacing:.4px;
  color:var(--clr-text-dim);
  line-height:1.4;
}
.footer a{color:var(--clr-accent-alt);text-decoration:none;}
.footer a:hover{text-decoration:underline;}
.fab-home{
  position:fixed;
  bottom:20px;
  right:20px;
  background:linear-gradient(135deg,var(--clr-accent),var(--clr-accent-alt));
  color:#fff;
  width:56px;
  height:56px;
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.3rem;
  text-decoration:none;
  font-weight:700;
  box-shadow:0 10px 28px -6px rgba(0,0,0,.55);
  transition:var(--transition);
  z-index:120;
}
.fab-home:hover{transform:translateY(-5px);}
.fab-home:focus{outline:none;box-shadow:var(--focus-ring);}
.tag-positive{color:var(--success);}
.tag-negative{color:var(--danger);}
.tag-neutral{color:var(--clr-text-dim);}
</style>
</head>
<body>
<header class="topbar">
  <nav>
    <a href="#top" class="home-btn" aria-label="Home">⌂</a>
  </nav>
  <a class="brand" href="#top"><span class="logo">AirMetrics</span> <span style="font-size:.65rem;color:var(--clr-text-dim);letter-spacing:.5px;">RASM/CASM Tool</span></a>
  <div class="currency-select">
    <label for="currencySel">Currency</label>
    <select id="currencySel" aria-label="Select currency">
      <option value="USD" selected>USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="CAD">CAD</option>
      <option value="AUD">AUD</option>
      <option value="JPY">JPY</option>
    </select>
  </div>
</header>

<main id="top">
  <span class="notice-inline">Inputs assumed in thousands (000) of chosen currency unless stated.</span>
  <h1>RASM / CASM / Yield Calculator</h1>
  <p class="lede">Quickly derive key airline unit metrics. Provide traffic and financial inputs to see RASM, PRASM, Yield, CASM, break-even load factor, operating margin and contribution. Use scenario sliders to explore how changes in load factor, yield and unit cost shape performance. Interactive charts visualize unit economics, revenue mix and margin sensitivity.</p>

  <div class="grid">
    <!-- INPUT CARD -->
    <div class="card" id="inputs">
      <h2>Base Inputs</h2>
      <div class="field">
        <label for="asm">ASMs (000)</label>
        <input id="asm" type="number" value="850000" min="0" step="1000">
      </div>
      <div class="field">
        <label for="rpm">RPMs (000)</label>
        <input id="rpm" type="number" value="680000" min="0" step="1000">
      </div>
      <div class="field">
        <label for="paxRev">Passenger Revenue (<span class="cur-code">USD</span> 000)</label>
        <input id="paxRev" type="number" value="920000" min="0" step="1000">
      </div>
      <div class="field">
        <label for="ancRev">Ancillary Revenue (000)</label>
        <input id="ancRev" type="number" value="110000" min="0" step="1000">
      </div>
      <div class="field">
        <label for="cargoRev">Cargo + Other Revenue (000)</label>
        <input id="cargoRev" type="number" value="60000" min="0" step="1000">
      </div>
      <div class="field">
        <label for="opCost">Operating Cost (000)</label>
        <input id="opCost" type="number" value="920000" min="0" step="1000">
      </div>
      <div class="field">
        <label for="taxes">Passenger Taxes (000, optional)</label>
        <input id="taxes" type="number" value="0" min="0" step="500">
      </div>
      <div class="status" id="status" role="status" aria-live="polite">Ready.</div>
      <button id="shareBtn" type="button" class="share-btn">Share</button>
      <small class="note">Break-even load factor ≈ CASM / Yield (if Yield &gt; 0). Per-unit metrics shown in <strong>cents of selected currency</strong> (or minor unit). All revenue & cost inputs are in thousands.</small>
    </div>

    <!-- METRICS + ADJUSTMENTS + CHARTS -->
    <div class="card">
      <h2>Calculated Metrics</h2>
      <div class="metric-box">
        <div class="metric"><h3>Load Factor</h3><div class="val" id="lfVal">—</div></div>
        <div class="metric"><h3>Yield</h3><div class="val" id="yieldVal">—</div><small class="note">Passenger revenue / RPM</small></div>
        <div class="metric"><h3>PRASM</h3><div class="val" id="prasmVal">—</div><small class="note">Passenger revenue / ASM</small></div>
        <div class="metric"><h3>RASM</h3><div class="val" id="rasmVal">—</div><small class="note">(Passenger + ancillary + cargo)/ASM</small></div>
        <div class="metric"><h3>CASM</h3><div class="val" id="casmVal">—</div><small class="note">Operating cost / ASM</small></div>
        <div class="metric"><h3>Break-Even LF</h3><div class="val" id="belfVal">—</div></div>
        <div class="metric"><h3>Operating Margin</h3><div class="val" id="marginVal">—</div></div>
        <div class="metric"><h3>Contribution (000)</h3><div class="val" id="contribVal">—</div></div>
      </div>

      <hr class="divider">

      <h2 style="margin-top:.2rem;">Scenario Sliders</h2>
      <small class="note">Sliders override correlated fields (RPM, Passenger Revenue, Operating Cost, Ancillary). Adjust to explore impact; you can still manually edit base numbers afterward.</small>

      <div class="range-field">
        <label for="lfSlider">Load Factor (%) <span class="slider-val" id="lfSliderVal">—</span></label>
        <input type="range" id="lfSlider" min="50" max="97" step="1">
      </div>
      <div class="range-field">
        <label for="yieldSlider">Yield (¢ / RPM) <span class="slider-val" id="yieldSliderVal">—</span></label>
        <input type="range" id="yieldSlider" min="5" max="30" step=".1">
      </div>
      <div class="range-field">
        <label for="casmSlider">CASM (¢ / ASM) <span class="slider-val" id="casmSliderVal">—</span></label>
        <input type="range" id="casmSlider" min="4" max="25" step=".1">
      </div>
      <div class="range-field">
        <label for="ancSlider">Ancillary (¢ / ASM) <span class="slider-val" id="ancSliderVal">—</span></label>
        <input type="range" id="ancSlider" min="0" max="10" step=".1">
      </div>

      <hr class="divider">

      <h2 style="margin-top:.2rem;">Visualizations</h2>
      <div class="charts-grid">
        <div class="chart-box">
          <h3>Unit Revenue vs Cost</h3>
          <div class="chart-fallback" id="fb-unit">Loading chart…</div>
          <canvas id="unitBarChart" aria-label="Bar chart RASM vs CASM vs PRASM"></canvas>
        </div>
        <div class="chart-box">
          <h3>Margin vs Load Factor</h3>
            <div class="chart-fallback" id="fb-margin">Loading chart…</div>
          <canvas id="marginLineChart" aria-label="Line chart margin versus load factor"></canvas>
        </div>
        <div class="chart-box">
          <h3>Revenue Mix</h3>
            <div class="chart-fallback" id="fb-mix">Loading chart…</div>
          <canvas id="revMixChart" aria-label="Pie chart revenue mix"></canvas>
        </div>
      </div>

    </div>
  </div>
</main>

<a href="#top" class="fab-home" aria-label="Back to top/home">⌂</a>

<div class="footer">
  <strong>Notes:</strong> This tool is for educational modeling only. Exchange rates are approximate & static. Adjust ranges to align with your network, stage length and cost structure. Graph calculations assume cost per ASM stays constant across load factor scenarios (simplified).<br>
  © <span id="year"></span> AirMetrics Demo.
</div>

<!-- FIX: Removed integrity (was causing blocked load). Defer ensures it's parsed before onload code. -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
(function(){
  const ids=['asm','rpm','paxRev','ancRev','cargoRev','opCost','taxes'];
  const el={}; ids.forEach(i=>el[i]=document.getElementById(i));

  // Elements
  const lfVal=$('lfVal'),yieldVal=$('yieldVal'),prasmVal=$('prasmVal'),rasmVal=$('rasmVal'),casmVal=$('casmVal'),belfVal=$('belfVal'),marginVal=$('marginVal'),contribVal=$('contribVal');
  const statusEl=$('status'), shareBtn=$('shareBtn');
  const currencySel=$('currencySel');
  const curCodeEls=[...document.querySelectorAll('.cur-code')];
  $('year').textContent=new Date().getFullYear();

  // Sliders
  const lfSlider=$('lfSlider'),yieldSlider=$('yieldSlider'),casmSlider=$('casmSlider'),ancSlider=$('ancSlider');
  const lfSliderVal=$('lfSliderVal'),yieldSliderVal=$('yieldSliderVal'),casmSliderVal=$('casmSliderVal'),ancSliderVal=$('ancSliderVal');

  // Chart placeholders
  const fbUnit=$('fb-unit'), fbMargin=$('fb-margin'), fbMix=$('fb-mix');

  let unitBarChart, marginLineChart, revMixChart;
  const currencyData={
    USD:{rate:1,symbol:'$',minorLabel:'¢'},
    EUR:{rate:0.92,symbol:'€',minorLabel:'c'},
    GBP:{rate:0.78,symbol:'£',minorLabel:'p'},
    CAD:{rate:1.36,symbol:'C$',minorLabel:'¢'},
    AUD:{rate:1.50,symbol:'A$',minorLabel:'¢'},
    JPY:{rate:146,symbol:'¥',minorLabel:'¥'} // treat value as yen; per-unit "cents" concept simplified
  };
  let currentCurrency='USD';
  let firstSyncDone=false;

  function $(id){return document.getElementById(id);}
  function num(v){return parseFloat(v)||0;}
  function fmt0(x){return x.toFixed(0);}
  function clamp(v,a,b){return Math.min(Math.max(v,a),b);}

  function asm(){return num(el.asm.value);}
  function rpm(){return num(el.rpm.value);}

  function calc(updateCharts=true){
    const ASM=asm();
    const RPM=rpm();
    const paxRev=num(el.paxRev.value);
    const ancRev=num(el.ancRev.value);
    const cargoRev=num(el.cargoRev.value);
    const opCost=num(el.opCost.value);
    const paxTaxes=num(el.taxes.value);

    if(ASM<=0 || RPM<0){
      statusEl.textContent='Enter ASM & RPM.';
      return;
    }

    const lf=RPM/ASM;
    const yieldNum= RPM>0 ? paxRev/RPM : 0;
    const prasm = paxRev/ASM;
    const rasm = (paxRev+ancRev+cargoRev)/ASM;
    const casm = opCost/ASM;
    const belf = yieldNum>0 ? casm / yieldNum : 0;
    const contribution = (paxRev+ancRev+cargoRev)-opCost-paxTaxes;
    const margin = (paxRev+ancRev+cargoRev)>0 ? contribution/(paxRev+ancRev+cargoRev) : 0;

    const minor=currencyData[currentCurrency].minorLabel;

    lfVal.textContent=(lf*100).toFixed(1)+'%';
    yieldVal.textContent=(yieldNum*100).toFixed(2)+' '+minor;
    prasmVal.textContent=(prasm*100).toFixed(2)+' '+minor;
    rasmVal.textContent=(rasm*100).toFixed(2)+' '+minor;
    casmVal.textContent=(casm*100).toFixed(2)+' '+minor;
    belfVal.textContent=(belf*100).toFixed(1)+'%';
    marginVal.textContent=(margin*100).toFixed(1)+'%';
    contribVal.textContent=fmt0(contribution);

    marginVal.classList.remove('tag-positive','tag-negative','tag-neutral');
    if(margin>0.15) marginVal.classList.add('tag-positive');
    else if(margin<0) marginVal.classList.add('tag-negative');
    else marginVal.classList.add('tag-neutral');

    statusEl.textContent='Updated.';

    if(!firstSyncDone){
      syncSlidersFromNumbers();
      firstSyncDone=true;
    }

    if(updateCharts){
      updateChartsData({rasm,prasm,casm,yieldNum,ASM,ancRev,cargoRev,opCost,paxTaxes});
    }
  }

  function syncSlidersFromNumbers(){
    if(asm()>0){
      const lfPerc=(rpm()/asm())*100;
      lfSlider.value=clamp(lfPerc,lfSlider.min,lfSlider.max);
      lfSliderVal.textContent=lfSlider.value+'%';
      const casmC=(num(el.opCost.value)/asm())*100;
      casmSlider.value=clamp(casmC,casmSlider.min,casmSlider.max);
      casmSliderVal.textContent=casmSlider.value+'¢';
      const ancC=(num(el.ancRev.value)/asm())*100;
      ancSlider.value=clamp(ancC,ancSlider.min,ancSlider.max);
      ancSliderVal.textContent=ancSlider.value+'¢';
    }
    if(rpm()>0){
      const yC=(num(el.paxRev.value)/rpm())*100;
      yieldSlider.value=clamp(yC,yieldSlider.min,yieldSlider.max);
      yieldSliderVal.textContent=yieldSlider.value+'¢';
    }
  }

  // Slider events
  lfSlider.addEventListener('input',()=>{
    if(asm()>0){
      el.rpm.value=Math.round(asm()*(num(lfSlider.value)/100));
    }
    lfSliderVal.textContent=lfSlider.value+'%';
    calc();
    updateURL();
  });
  yieldSlider.addEventListener('input',()=>{
    if(rpm()>0){
      el.paxRev.value=Math.round((num(yieldSlider.value)/100)*rpm());
    }
    yieldSliderVal.textContent=yieldSlider.value+'¢';
    calc();
    updateURL();
  });
  casmSlider.addEventListener('input',()=>{
    if(asm()>0){
      el.opCost.value=Math.round((num(casmSlider.value)/100)*asm());
    }
    casmSliderVal.textContent=casmSlider.value+'¢';
    calc();
    updateURL();
  });
  ancSlider.addEventListener('input',()=>{
    if(asm()>0){
      el.ancRev.value=Math.round((num(ancSlider.value)/100)*asm());
    }
    ancSliderVal.textContent=ancSlider.value+'¢';
    calc();
    updateURL();
  });

  // Currency
  currencySel.addEventListener('change',()=>{
    const newCur=currencySel.value;
    if(newCur!==currentCurrency){
      convertCurrency(currentCurrency,newCur);
      currentCurrency=newCur;
      curCodeEls.forEach(c=>c.textContent=newCur);
      calc(); // will update charts with new minor label
    }
  });

  function convertCurrency(from,to){
    const fr=currencyData[from].rate;
    const tr=currencyData[to].rate;
    ['paxRev','ancRev','cargoRev','opCost','taxes'].forEach(k=>{
      const val=num(el[k].value);
      const inUSD=val/fr;
      el[k].value=Math.round(inUSD*tr);
    });
    updateURL();
  }

  // URL state
  function updateURL(){
    const url=new URL(location.href);
    ids.forEach(i=>url.searchParams.set(i,el[i].value));
    url.searchParams.set('cur',currentCurrency);
    url.searchParams.set('lfS',lfSlider.value);
    url.searchParams.set('yS',yieldSlider.value);
    url.searchParams.set('cS',casmSlider.value);
    url.searchParams.set('aS',ancSlider.value);
    history.replaceState({},'',url);
  }
  function loadFromURL(){
    const p=new URLSearchParams(location.search);
    let changed=false;
    ids.forEach(i=>{
      if(p.has(i)){
        el[i].value=p.get(i);
        changed=true;
      }
    });
    if(p.has('cur') && currencyData[p.get('cur')]){
      currentCurrency=p.get('cur');
      currencySel.value=currentCurrency;
      curCodeEls.forEach(c=>c.textContent=currentCurrency);
    }
    if(p.has('lfS')){lfSlider.value=p.get('lfS');lfSliderVal.textContent=lfSlider.value+'%';}
    if(p.has('yS')){yieldSlider.value=p.get('yS');yieldSliderVal.textContent=yieldSlider.value+'¢';}
    if(p.has('cS')){casmSlider.value=p.get('cS');casmSliderVal.textContent=casmSlider.value+'¢';}
    if(p.has('aS')){ancSlider.value=p.get('aS');ancSliderVal.textContent=ancSlider.value+'¢';}
    if(changed) calc(false);
  }

  ids.forEach(i=>el[i].addEventListener('input',()=>{firstSyncDone=false;calc();updateURL();}));

  shareBtn.addEventListener('click',()=>{
    navigator.clipboard.writeText(location.href).then(()=>{
      shareBtn.classList.add('copied');
      shareBtn.textContent='Copied!';
      setTimeout(()=>{shareBtn.classList.remove('copied');shareBtn.textContent='Share';},1500);
    });
  });

  // Chart init with retry if CDN not yet ready
  function initChartsWhenReady(attempt=0){
    if(typeof window.Chart==='undefined'){
      if(attempt<15){
        return setTimeout(()=>initChartsWhenReady(attempt+1),150); // retry
      } else {
        console.error('Chart.js failed to load after retries.');
        fbUnit.textContent='Chart library not loaded.';
        fbMargin.textContent='Chart library not loaded.';
        fbMix.textContent='Chart library not loaded.';
        return;
      }
    }
    // Remove fallbacks
    [fbUnit,fbMargin,fbMix].forEach(f=>f.remove());

    const barCtx=$('unitBarChart');
    const lineCtx=$('marginLineChart');
    const pieCtx=$('revMixChart');

    unitBarChart=new Chart(barCtx,{
      type:'bar',
      data:{
        labels:['RASM','PRASM','CASM'],
        datasets:[{
          data:[0,0,0],
            backgroundColor:[
              'rgba(50,152,220,0.75)',
              'rgba(110,205,255,0.75)',
              'rgba(240,110,110,0.75)'
            ],
            borderRadius:8
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{callbacks:{label:ctx=>ctx.parsed.y.toFixed(2)+' '+currencyData[currentCurrency].minorLabel}}
        },
        scales:{
          y:{beginAtZero:true,grid:{color:'rgba(255,255,255,.07)'},ticks:{color:'#9fb3c5'},title:{display:true,text:'Cents ('+currencyData[currentCurrency].minorLabel+')',color:'#9fb3c5',font:{size:10}}},
          x:{grid:{display:false},ticks:{color:'#9fb3c5'}}
        }
      }
    });

    marginLineChart=new Chart(lineCtx,{
      type:'line',
      data:{labels:[],datasets:[{label:'Operating Margin %',data:[],fill:false,tension:.25,borderColor:'rgba(79,177,245,1)',pointBackgroundColor:'rgba(79,177,245,1)',pointRadius:3}]},
      options:{
        responsive:true,
        plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>ctx.parsed.y.toFixed(1)+'%'}}},
        scales:{
          y:{beginAtZero:true,suggestedMax:30,grid:{color:'rgba(255,255,255,.07)'},ticks:{color:'#9fb3c5',callback:v=>v+'%'}},
          x:{grid:{display:false},ticks:{color:'#9fb3c5'},title:{display:true,text:'Load Factor %',color:'#9fb3c5',font:{size:10}}}
        }
      }
    });

    revMixChart=new Chart(pieCtx,{
      type:'doughnut',
      data:{labels:['Passenger','Ancillary','Cargo/Other'],datasets:[{data:[0,0,0],backgroundColor:['rgba(50,152,220,0.85)','rgba(53,179,118,0.85)','rgba(230,179,76,0.85)'],borderWidth:0}]},
      options:{
        responsive:true,
        plugins:{
          legend:{position:'bottom',labels:{color:'#9fb3c5',font:{size:10}}},
          tooltip:{callbacks:{label:ctx=>ctx.label+': '+fmt0(ctx.parsed)+'k '+currentCurrency}}
        },
        cutout:'58%'
      }
    });

    calc(); // populate with real data now
  }

  function updateChartsData(vals){
    if(!unitBarChart) return;
    const rasmC=vals.rasm*100;
    const prasmC=vals.prasm*100;
    const casmC=vals.casm*100;
    unitBarChart.data.datasets[0].data=[rasmC,prasmC,casmC];
    unitBarChart.options.scales.y.title.text='Cents ('+currencyData[currentCurrency].minorLabel+')';
    unitBarChart.update();

    // Margin sensitivity
    const ASM=vals.ASM;
    const yieldPerRPM=vals.yieldNum;
    const ancRev=num(el.ancRev.value);
    const cargoRev=num(el.cargoRev.value);
    const opCost=num(el.opCost.value);
    const paxTaxes=num(el.taxes.value);
    const lfLabels=[];
    const marginSeries=[];
    for(let lf=50; lf<=100; lf+=2){
      const RPM=ASM*(lf/100);
      const paxRev=yieldPerRPM*RPM;
      const totalRev=paxRev+ancRev+cargoRev;
      const contrib=totalRev-opCost-paxTaxes;
      const m= totalRev>0 ? (contrib/totalRev)*100 : 0;
      lfLabels.push(lf);
      marginSeries.push(+m.toFixed(2));
    }
    marginLineChart.data.labels=lfLabels;
    marginLineChart.data.datasets[0].data=marginSeries;
    marginLineChart.update();

    // Revenue mix
    revMixChart.data.datasets[0].data=[num(el.paxRev.value), num(el.ancRev.value), num(el.cargoRev.value)];
    revMixChart.update();
  }

  // INIT
  loadFromURL();
  // We delay chart init until DOM & (hopefully) script loaded
  window.addEventListener('load', ()=> {
    initChartsWhenReady();
    calc();
  });

})();
</script>
</body>
</html>
