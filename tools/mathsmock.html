  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Vivaan's Maths Practice - Test Mode</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <style>
      body {font-family: Arial, sans-serif;margin:0;padding:0;background:#f5f7fa;color:#333;}
      header {background:#4a90e2;color:#fff;padding:15px;text-align:center;font-size:1.6rem;font-weight:bold;}
      #top-bar {display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:flex-start;padding:10px 12px;background:#eef3f9;}
      #top-bar select, #top-bar button {padding:8px 12px;border-radius:6px;border:1px solid #bbb;font-size:0.9rem;cursor:pointer;background:#fff;}
      #top-bar button.action {background:#4a90e2;color:#fff;border:none;}
      #top-bar button.action:hover {background:#357ab7;}
      #stats {font-size:0.8rem;line-height:1.15em;min-width:140px;}
      .container {max-width:980px;margin:15px auto 40px;padding:0 15px;}
      .card {background:#fff;border-radius:12px;padding:16px 18px;margin-bottom:18px;box-shadow:0 4px 10px rgba(0,0,0,0.08);position:relative;}
      .card h2 {margin:0 0 8px;font-size:1.05rem;display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
      .question {font-size:0.95rem;margin-bottom:10px;white-space:pre-line;}
      .options button {display:block;width:100%;margin:5px 0;padding:10px 12px;border:none;border-radius:8px;background:#f0f0f0;font-size:0.9rem;cursor:pointer;text-align:left;transition:0.25s;position:relative;}
      .options button:hover {background:#e5e5e5;}
      .options button.correct {background:#4CAF50;color:#fff;}
      .options button.wrong {background:#E74C3C;color:#fff;}
      .options button.selected-during-test {outline:2px solid #4a90e2;background:#e6f1fc;}
      .hint, .working {display:none;margin-top:8px;padding:8px 10px;background:#f8faff;border-left:4px solid #4a90e2;border-radius:6px;font-size:0.75rem;white-space:pre-line;}
      .section-meta {display:none;font-size:0.7rem;color:#555;margin-top:6px;}
      .badges {display:flex;gap:6px;flex-wrap:wrap;}
      .badge {background:#4a90e2;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.5px;}
      .floating-timer {position:fixed;bottom:15px;right:15px;background:#4a90e2;color:#fff;padding:8px 12px;border-radius:8px;font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,0.25);z-index:100;}
      .mistakes-tab {background:#fff;border:1px solid #f5c6cb;padding:15px;border-radius:10px;}
      .mistakes-tab h3 {margin-top:0;color:#c0392b;}
      .reset-btn {background:#4a90e2;color:#fff;border:none;padding:10px 15px;font-size:1rem;border-radius:8px;cursor:pointer;margin-top:15px;}
      .reset-btn:hover {background:#357ab7;}
      #export-output {width:100%;height:150px;font-size:0.75rem;white-space:pre;display:none;margin-top:10px;}
      #finish-banner {display:none;padding:14px 16px;margin:20px auto 10px;max-width:960px;border-left:6px solid #4a90e2;background:#ffffff;box-shadow:0 2px 6px rgba(0,0,0,0.12);border-radius:8px;}
      #finish-banner h3 {margin:0 0 8px;font-size:1.05rem;}
      #finish-summary {font-size:0.85rem;white-space:pre-line;}
      .time-chip {position:absolute;top:6px;right:6px;font-size:0.6rem;background:#eee;padding:2px 6px;border-radius:10px;color:#444;display:none;}
      .time-chip.recorded {display:inline-block;background:#4a90e2;color:#fff;}
      .question-unanswered {border-left:5px solid #ffc107;padding-left:10px;}
      .question-correct {border-left:5px solid #4CAF50;padding-left:10px;}
      .question-wrong {border-left:5px solid #E74C3C;padding-left:10px;}
      #show-answers-btn[disabled], #finish-test-btn[disabled] {opacity:0.5;cursor:default;}
      @media (max-width:640px){
        #top-bar {flex-direction:column;align-items:stretch;}
        .floating-timer {bottom:10px;right:10px;}
      }
    </style>
  </head>
  <body>
    <header>Vivaan's Maths Practice (Test Mode)</header>

    <div id="top-bar">
      <label>
        Difficulty:
        <select id="difficulty-select">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
          <option value="adaptive">Adaptive</option>
        </select>
      </label>
      <button class="action" id="new-test-btn">New Test</button>
      <button class="action" id="finish-test-btn" disabled>Finish Test</button>
      <button class="action" id="show-answers-btn" disabled>Reveal Answers</button>
      <button class="action" id="export-mistakes-btn" disabled>Export Mistakes</button>
      <button class="action" id="export-test-btn" disabled>Export Full Test</button>
      <button class="action" id="toggle-hints-btn">Toggle Hints</button>
      <button class="action" id="toggle-workings-btn">Toggle Workings</button>
      <button class="action" id="clear-score-btn">Clear Scores</button>
      <div id="stats">
        <div>Questions: <span id="stat-total">0</span></div>
        <div>Answered: <span id="stat-answered">0</span></div>
        <div>Correct: <span id="stat-correct">0</span></div>
        <div>Accuracy: <span id="stat-accuracy">0%</span></div>
        <div>Current Difficulty: <span id="stat-diff">Medium</span></div>
        <div>Adaptive Trend: <span id="stat-trend">-</span></div>
        <div>Test State: <span id="stat-state">Idle</span></div>
      </div>
    </div>

    <div id="finish-banner">
      <h3>Test Finished</h3>
      <div id="finish-summary"></div>
    </div>

    <div class="container" id="cards-container">
      <!-- Section cards (kept same IDs) -->
      <!-- For brevity only structural repetition: identical pattern; no per-section "New" buttons now -->
      <!-- You can collapse while reading; functional code below populates -->
      <div class="card" id="mean-average-section">
        <h2>Mean Average <span class="badge" data-diff-tag="mean-average-section"></span></h2>
        <span class="time-chip" id="time-mean-average-section"></span>
        <div class="question" id="mean-average-question"></div>
        <div class="options" id="mean-average-options"></div>
        <div class="hint" id="hint-mean-average-section"></div>
        <div class="working" id="working-mean-average-section"></div>
        <div class="section-meta" id="meta-mean-average-section"></div>
      </div>

      <!-- We'll generate remaining sections dynamically via template clone to reduce code duplication -->
    </div>

    <div class="card mistakes-tab" id="mistakes-tab">
      <h3>Mistakes</h3>
      <ul id="mistakes-list"></ul>
      <textarea id="export-output" readonly></textarea>
    </div>

    <div id="timer" class="floating-timer">Time: 0s</div>

    <script>
      /******************** CONFIG ********************/
      const SECTION_DEFS = [
        {id:'mean-average-section', title:'Mean Average'},
        {id:'bearings-section', title:'Bearings'},
        {id:'time-section', title:'Time & Measurements'},
        {id:'ordering-section', title:'Ordering (Middle Value)'},
        {id:'decimal-ordering-section', title:'Larger Decimals Ordering'},
        {id:'percentage-discount-section', title:'Percentage Discount'},
        {id:'reverse-calc-section', title:'Reverse Calculation'},
        {id:'bodmas-section', title:'BODMAS / Arithmetic'},
        {id:'percentage-section', title:'Percentage Calculations'},
        {id:'angle-section', title:'Percentage of Angles'},
        {id:'day-week-section', title:'Day of the Week'},
        {id:'total-bill-section', title:'Total Bill (Reverse %)'},
        {id:'temperature-section', title:'Temperature Sequence'},
        {id:'number-sequence-section', title:'Number & Sequence'},
        {id:'ratio-sharing-section', title:'Ratio Sharing'},
        {id:'fraction-simplify-section', title:'Simplify Fractions'},
        {id:'fraction-of-amount-section', title:'Fraction of Amount'},
        {id:'fraction-convert-section', title:'Fraction Conversion'},
        {id:'probability-section', title:'Basic Probability'},
        {id:'area-perimeter-section', title:'Area & Perimeter'},
        {id:'factors-multiples-section', title:'LCM / HCF'},
        {id:'prime-number-section', title:'Prime Numbers'},
        {id:'solve-x-section', title:'Solve for x'},
        {id:'speed-distance-time-section', title:'Speed / Distance / Time'},
        {id:'volume-cuboid-section', title:'Volume of a Cuboid'},
        {id:'triangle-angle-section', title:'Missing Triangle Angle'}
      ];

      /******************** STATE ********************/
      const QUESTION_REGISTRY = {};         // sectionId -> question object
      const QUESTION_HISTORY = [];          // array of question objects (export)
      let difficultyMode = 'medium';
      let adaptiveLevel = 2;
      let totalAnswered = 0;
      let totalCorrect = 0;
      let testActive = false;
      let testFinished = false;
      let testStartTime = null;
      let seconds = 0;
      let timerInterval = null;
      let RECENT_RESULTS = []; // for adaptive (only updated at end now)

      /******************** UTILITIES ********************/
      function shuffle(a){return a.sort(()=>Math.random()-0.5);}
      function gcd(a,b){return b===0?a:gcd(b,a%b);}
      function isPrime(n){if(n<2) return false; for(let i=2;i*i<=n;i++) if(n%i===0) return false; return true;}
      function nowMs(){return Date.now();}
      function humanTime(ms){
        const s=Math.round(ms/1000);
        if(s<60) return s+"s";
        const m=Math.floor(s/60);
        const r=s%60;
        return m+"m "+r+"s";
      }
      function currentNumericDifficulty(){
        if(difficultyMode==='easy') return 1;
        if(difficultyMode==='medium') return 2;
        if(difficultyMode==='hard') return 3;
        return adaptiveLevel;
      }
      function updateDifficultyStat(){
        const levelName = difficultyMode==='adaptive'
          ? (adaptiveLevel===1?'Adaptive (Easy)':adaptiveLevel===2?'Adaptive (Medium)':'Adaptive (Hard)')
          : difficultyMode.charAt(0).toUpperCase()+difficultyMode.slice(1);
        document.getElementById('stat-diff').textContent = levelName;
        document.querySelectorAll('[data-diff-tag]').forEach(el=>el.textContent=levelName.includes('Adaptive')?levelName.split(' ')[1]:difficultyMode);
      }
      function updateStatsDisplay(){
        document.getElementById('stat-total').textContent = SECTION_DEFS.length;
        document.getElementById('stat-answered').textContent = totalAnswered;
        document.getElementById('stat-correct').textContent = totalCorrect;
        document.getElementById('stat-accuracy').textContent = totalAnswered===0? '0%': Math.round(100*totalCorrect/totalAnswered)+"%";
        document.getElementById('stat-state').textContent = testFinished? 'Finished' : (testActive ? 'In Progress':'Idle');
      }

      /******************** TIMER ********************/
      function startTimer(){
        clearInterval(timerInterval);
        seconds=0;
        document.getElementById('timer').textContent = "Time: 0s";
        timerInterval = setInterval(()=>{
          seconds++;
          document.getElementById('timer').textContent = `Time: ${seconds}s`;
        },1000);
      }
      function stopTimer(){ clearInterval(timerInterval); }

      /******************** QUESTION GENERATORS ********************/
      // (Reuse logic from previous version - condensed)
      function genMeanAverage(){
        const diff=currentNumericDifficulty();
        const length=diff===1?3:diff===2?4:6;
        const maxVal=diff===1?30:diff===2?60:120;
        const nums=Array.from({length},()=>Math.floor(Math.random()*maxVal)+1);
        const raw=nums.reduce((a,b)=>a+b,0)/length;
        const mean=raw.toFixed(diff===3?2:1);
        const opts=new Set([mean]);
        while(opts.size<4){
          let d=(Math.random()*(diff===3?4:2)-(diff===3?2:1));
          opts.add((raw+d).toFixed(diff===3?2:1));
        }
        return {
          question:`Find the mean average of ${nums.join(", ")}`,
          correctAnswer:mean,
          options:shuffle([...opts]),
          hint:"Add numbers then divide by how many.",
          working:`Sum=${nums.reduce((a,b)=>a+b,0)}, Count=${length}, Mean=${raw}`
        };
      }
      function genBearings(){
        const dir=["North","North East","East","South East","South","South West","West","North West"];
        const diff=currentNumericDifficulty();
        const startIndex=Math.floor(Math.random()*dir.length);
        const start=dir[startIndex];
        const turnChoices=diff===1?[90,180]:diff===2?[90,135,180,270]:[45,90,135,180,225,270,315];
        const turn=turnChoices[Math.floor(Math.random()*turnChoices.length)];
        const cw=Math.random()>0.5;
        let newIndex=cw?(startIndex+turn/45):(startIndex-turn/45);
        newIndex=(newIndex+dir.length)%dir.length;
        const ans=dir[newIndex];
        const opts=new Set([ans]);
        while(opts.size<4) opts.add(dir[Math.floor(Math.random()*dir.length)]);
        return {
          question:`I face ${start}. I turn ${turn}° ${cw?'clockwise':'anticlockwise'}. Which direction now?`,
          correctAnswer:ans,
          options:shuffle([...opts]),
          hint:"Compass has 45° increments here.",
          working:`Start idx ${startIndex}, steps ${turn/45} => new idx ${newIndex}`
        };
      }
      function genTime(){
        const diff=currentNumericDifficulty();
        const baseTimes=[
          {h:0,m:0,label:'midnight'},
          {h:12,m:0,label:'noon'},
          {h:6,m:45,label:'6:45am'},
          {h:15,m:30,label:'3:30pm'},
          {h:23,m:15,label:'11:15pm'}
        ];
        if(diff===1) baseTimes.pop();
        const base=baseTimes[Math.floor(Math.random()*baseTimes.length)];
        const offsetH=Math.floor(Math.random()*(diff===1?6:diff===2?10:18))+1;
        const offsetM=Math.floor(Math.random()*(diff===3?60:30));
        const before=Math.random()>0.5;
        let total=base.h*60+base.m+(before?-1:1)*(offsetH*60+offsetM);
        while(total<0) total+=1440;
        total%=1440;
        const h=Math.floor(total/60);
        const m=total%60;
        const formatted=`${((h+11)%12+1)}:${m.toString().padStart(2,'0')}${h<12?'am':'pm'}`;
        const opts=new Set([formatted]);
        while(opts.size<5){
          const rH=Math.floor(Math.random()*24), rM=Math.floor(Math.random()*60);
          const r=`${((rH+11)%12+1)}:${rM.toString().padStart(2,'0')}${rH<12?'am':'pm'}`;
          opts.add(r);
        }
        return {
          question:`What time is ${offsetH}h ${offsetM}m ${before?'before':'after'} ${base.label}?`,
          correctAnswer:formatted,
          options:shuffle([...opts]),
          hint:"Convert to minutes from midnight.",
          working:`Base=${base.h*60+base.m} offset=${offsetH*60+offsetM} => total=${total}`
        };
      }
      function genOrdering(){
        const diff=currentNumericDifficulty();
        const count=diff===1?5:7;
        const nums=Array.from({length:count},()=>parseFloat((Math.random()*40-10).toFixed(diff===3?4:diff===2?3:2)));
        const sorted=[...nums].sort((a,b)=>a-b);
        const middle=sorted[Math.floor(sorted.length/2)];
        return {
          question:`Order from smallest to largest: ${nums.join(", ")}. Which is the middle value?`,
          correctAnswer:middle.toString(),
          options:shuffle(nums.slice(0,4).map(String)),
          hint:"Sort; pick median.",
          working:`Sorted: ${sorted.join(", ")}`
        };
      }
      function genDecimalOrdering(){
        const diff=currentNumericDifficulty();
        const count=diff===1?5:7;
        const prec=diff===1?2:diff===2?4:6;
        const vals=Array.from({length:count},()=>parseFloat((Math.random()*20).toFixed(prec)));
        const sorted=[...vals].sort((a,b)=>a-b);
        const mid=sorted[Math.floor(sorted.length/2)];
        return {
          question:`Decimals: ${vals.join(", ")}. Middle when ordered?`,
          correctAnswer:mid.toString(),
          options:shuffle(vals.slice(0,4).map(String)),
          hint:"Median value in sorted list.",
          working:`Sorted: ${sorted.join(", ")}`
        };
      }
      function genPercentageDiscount(){
        const diff=currentNumericDifficulty();
        const baseMax=diff===1?100:diff===2?300:1000;
        const original=(Math.random()*baseMax+10).toFixed(2);
        const discount=diff===1?Math.floor(Math.random()*21)+5:diff===2?Math.floor(Math.random()*31)+5:Math.floor(Math.random()*46)+5;
        const sale=(original*(1-discount/100)).toFixed(2);
        const opts=new Set([sale]);
        while(opts.size<4){
          let f=1+(Math.random()*0.1-0.05);
          opts.add((sale*f).toFixed(2));
        }
        return {
          question:`${discount}% off an item at £${original}. Sale price?`,
          correctAnswer:sale,
          options:shuffle([...opts]),
          hint:"Sale = Original × (1 - discount%).",
          working:`${original}×(1-${discount}/100) = £${sale}`
        };
      }
      function genReverseCalc(){
        const diff=currentNumericDifficulty();
        const original=Math.floor(Math.random()*(diff===1?15:diff===2?30:60))+5;
        const multipliers=diff===3?[2,3,4,5,6,8,9,12]:[2,4,8,16];
        const multiplier=multipliers[Math.floor(Math.random()*multipliers.length)];
        const divisor=[1,2,4,5,8,10,16][Math.floor(Math.random()*7)];
        const add=Math.floor(Math.random()*(diff===3?200:diff===2?100:50))+(diff===3?50:diff===2?30:10);
        const result=((original*multiplier)/divisor+add).toFixed(2);
        const opts=new Set([original.toString()]);
        while(opts.size<4){
          let v=original+Math.floor(Math.random()*7-3);
          if(v>0) opts.add(v.toString());
        }
        return {
          question:`Think of a number, ×${multiplier}, ÷${divisor}, +${add} = ${result}. Original number?`,
          correctAnswer:original.toString(),
          options:shuffle([...opts]),
          hint:"Undo steps in reverse order.",
          working:`x = (( ${result} - ${add} ) * ${divisor} ) / ${multiplier}`
        };
      }
      function genBODMAS(){
        const diff=currentNumericDifficulty();
        const length=diff===1?4:diff===2?5:6;
        const nums=Array.from({length},()=>Math.floor(Math.random()*(diff===3?90:50))+1);
        const opsSet=diff===1?['+','-']:diff===2?['+','-','*']:['+','-','*','÷'];
        let expr=""+nums[0];
        for(let i=1;i<nums.length;i++) expr+=" "+opsSet[Math.floor(Math.random()*opsSet.length)]+" "+nums[i];
        let val;
        try{val=eval(expr.replace(/÷/g,'/'));}catch(e){val=0;}
        const correct=(diff===3?val.toFixed(2):val.toFixed(1));
        const opts=new Set([correct]);
        while(opts.size<4){
          let pert=(val+(Math.random()*(diff===3?10:5)-(diff===3?5:2.5))).toFixed(diff===3?2:1);
          opts.add(pert);
        }
        return {
          question:`Solve: ${expr}`,
          correctAnswer:correct,
          options:shuffle([...opts]),
          hint:"Follow order of operations.",
          working:`Computed using precedence evaluation.`
        };
      }
      function genPercentagePart(){
        const diff=currentNumericDifficulty();
        const total=Math.floor(Math.random()*(diff===1?80:diff===2?150:400))+20;
        const part=Math.floor(Math.random()*total);
        const pct=Math.round(part/total*100);
        const opts=new Set([pct]);
        while(opts.size<4){
          let p=pct+Math.floor(Math.random()*(diff===3?11:7)-(diff===3?5:3));
          if(p>=0&&p<=100) opts.add(p);
        }
        return {
          question:`${part} is _____% of ${total}`,
          correctAnswer:pct.toString(),
          options:shuffle([...opts].map(String)),
          hint:"(part / total) × 100",
          working:`(${part}/${total})×100 = ${pct}%`
        };
      }
      function genAnglePercent(){
        const diff=currentNumericDifficulty();
        const base=90;
        const percent=diff===1?Math.floor(Math.random()*41)+110:diff===2?Math.floor(Math.random()*81)+100:Math.floor(Math.random()*121)+90;
        const ans=Math.round(base*percent/100);
        const opts=new Set([ans]);
        while(opts.size<4){
          let v=ans+Math.floor(Math.random()*11-5);
          if(v>0) opts.add(v);
        }
        return {
          question:`How many degrees in ${percent}% of a right angle?`,
          correctAnswer:ans.toString(),
          options:shuffle([...opts].map(String)),
          hint:"Right angle = 90°.",
          working:`90 × ${percent}/100 = ${ans}°`
        };
      }
      function genDayOfWeek(){
        const diff=currentNumericDifficulty();
        const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        const startIdx=Math.floor(Math.random()*7);
        const startDate=Math.floor(Math.random()*20)+1;
        const offset=Math.floor(Math.random()*(diff===1?10:diff===2?20:50))+1;
        const ans=days[(startIdx+offset)%7];
        const opts=new Set([ans]);
        while(opts.size<5) opts.add(days[Math.floor(Math.random()*7)]);
        return {
          question:`If the ${startDate}th is a ${days[startIdx]}, what day is the ${startDate+offset}th?`,
          correctAnswer:ans,
          options:shuffle([...opts]),
          hint:"Increment day index by offset (mod 7).",
          working:`(${startIdx}+${offset}) % 7 = ${(startIdx+offset)%7}`
        };
      }
      function genTotalBill(){
        const diff=currentNumericDifficulty();
        const percentage=Math.floor(Math.random()*(diff===1?21:diff===2?31:51))+(diff===3?10:20);
        const total=Math.floor(Math.random()*(diff===1?80:diff===2?200:500))+30;
        const part=(total*percentage/100).toFixed(2);
        const correct=(part/percentage*100).toFixed(2);
        const opts=new Set([correct]);
        while(opts.size<5){
          let fuzz=(parseFloat(correct)+(Math.random()*(diff===3?40:20)-(diff===3?20:10))).toFixed(2);
            if(fuzz>0) opts.add(fuzz);
        }
        return {
          question:`I paid £${part}, which was ${percentage}% of the bill. What was the total?`,
          correctAnswer:correct,
          options:shuffle([...opts]),
          hint:"Total = part ÷ (percentage/100).",
          working:`${part} / (${percentage}/100) = £${correct}`
        };
      }
      function genTemperature(){
        const diff=currentNumericDifficulty();
        const monday=Math.floor(Math.random()*(diff===3?21:11))+(diff===1?5:10);
        const dropTue=Math.floor(Math.random()*(diff===1?4:diff===2?6:9))+2;
        const tue=monday-dropTue;
        const wMult=diff===1?2:(Math.random()*0.7+1.5);
        const wed=Math.round(tue*wMult);
        const thuDrop=Math.floor(Math.random()*(diff===3?6:4))+2;
        const thu=wed-thuDrop;
        const ans=thu+"°C";
        const opts=new Set([ans]);
        while(opts.size<5){
          let v=thu+Math.floor(Math.random()*9-4);
          opts.add(v+"°C");
        }
        return {
          question:`Temperatures:\nMon ${monday}°C\nTue ${dropTue}°C colder\nWed ~${wMult.toFixed(2)}× Tue\nThu ${thuDrop}°C colder than Wed\nThursday temperature?`,
          correctAnswer:ans,
          options:shuffle([...opts]),
          hint:"Track each day's adjustment.",
          working:`Tue=${monday}-${dropTue}=${tue}; Wed≈${tue}×${wMult.toFixed(2)}=${wed}; Thu=${wed}-${thuDrop}=${thu}`
        };
      }
      function genNumberSequence(){
        const diff=currentNumericDifficulty();
        const type=Math.floor(Math.random()*4);
        if(type===0) return {
          question:"How many tenths are there in 100?",
          correctAnswer:"1000",
          options:shuffle(["10","100","1000","1","10000"]),
          hint:"1 whole = 10 tenths.",
          working:"100 ÷ 0.1 = 1000"
        };
        if(type===1){
          const hour=Math.floor(Math.random()*12)+1;
          const minute=Math.floor(Math.random()*60);
          const ampm=Math.random()>0.5?'am':'pm';
          let h24=hour%12;
          if(ampm==='pm') h24+=12;
          if(ampm==='am'&&hour===12) h24=0;
          const ans=h24.toString().padStart(2,'0')+":"+minute.toString().padStart(2,'0');
          const opts=new Set([ans]);
          while(opts.size<5){
            const h=Math.floor(Math.random()*24),m=Math.floor(Math.random()*60);
            opts.add(h.toString().padStart(2,'0')+":"+m.toString().padStart(2,'0'));
          }
          return {
            question:`Convert ${hour}:${minute.toString().padStart(2,'0')}${ampm} to 24-hour time.`,
            correctAnswer:ans,
            options:shuffle([...opts]),
            hint:"Add 12 for pm (except 12pm). 12am=00.",
            working:`${hour}:${minute}${ampm} => ${ans}`
          };
        }
        if(type===2) return {
          question:"Which number is a square? 33, 19, 26, 14, 81",
          correctAnswer:"81",
          options:shuffle(["33","19","26","14","81"]),
          hint:"Square = n×n.",
          working:"81 = 9×9"
        };
        return {
          question:"Sequence: 1, 6, ?, 19, 27, ?, 46. Fill the two missing values.",
          correctAnswer:"11 and 35",
          options:shuffle(["11 and 35","11 and 34","12 and 34","12 and 35","12 and 36"]),
          hint:"Differences show repeated pattern.",
          working:"Missing values are 11 and 35."
        };
      }
      function genRatioSharing(){
        const diff=currentNumericDifficulty();
        const a=Math.floor(Math.random()*(diff===3?6:3))+2;
        const b=Math.floor(Math.random()*(diff===3?8:4))+3;
        const total=(Math.floor(Math.random()*(diff===3?40:20))+10)*(a+b);
        const first=Math.random()>0.5;
        const share=total*(first?a:b)/(a+b);
        const ans="£"+share;
        const opts=new Set([ans]);
        while(opts.size<4){
          const v=share+Math.floor(Math.random()*(diff===3?21:11)-(diff===3?10:5));
          if(v>0) opts.add("£"+v);
        }
        return {
          question:`£${total} shared in ratio ${a}:${b}. How much for the ${first?'first':'second'} person?`,
          correctAnswer:ans,
          options:shuffle([...opts]),
          hint:"Part = total × (ratio part / sum).",
          working:`Sum=${a+b}; share=${total}×${first?a:b}/${a+b}=£${share}`
        };
      }
      function genFractionSimplify(){
        const diff=currentNumericDifficulty();
        let base=Math.floor(Math.random()*(diff===3?12:8))+2;
        let m=Math.floor(Math.random()*(diff===3?9:5))+2;
        let n=Math.floor(Math.random()*(diff===3?9:5))+2;
        let num=base*m, den=base*n;
        let g=gcd(num,den);
        let simp=(num/g)+"/"+(den/g);
        const opts=new Set([simp]);
        while(opts.size<4){
          let d1=(num/g)+Math.floor(Math.random()*3-1);
          let d2=(den/g)+Math.floor(Math.random()*3-1);
          if(d1>0&&d2>0) opts.add(d1+"/"+d2);
        }
        return {
          question:`Simplify ${num}/${den}`,
          correctAnswer:simp,
          options:shuffle([...opts]),
          hint:"Divide numerator & denominator by HCF.",
          working:`HCF=${g} ⇒ ${num}/${den}=${num/g}/${den/g}`
        };
      }
      function genFractionOfAmount(){
        const diff=currentNumericDifficulty();
        const denom=Math.floor(Math.random()*(diff===3?15:10))+2;
        const numer=Math.floor(Math.random()*(diff===3?denom-1:Math.min(denom-1,8)))+1;
        const whole=(Math.floor(Math.random()*(diff===3?30:15))+5)*denom;
        const ans=whole*numer/denom;
        const opts=new Set([ans]);
        while(opts.size<4){
          let p=ans+Math.floor(Math.random()*(diff===3?21:11)-(diff===3?10:5));
          if(p>0) opts.add(p);
        }
        return {
          question:`What is ${numer}/${denom} of ${whole}?`,
          correctAnswer:ans.toString(),
          options:shuffle([...opts].map(String)),
          hint:"Multiply whole by numerator, divide by denominator.",
          working:`(${whole}×${numer})/${denom}=${ans}`
        };
      }
      function genFractionConvert(){
        const diff=currentNumericDifficulty();
        const denominators=diff===3?[2,3,4,5,6,8,9,10,12,15,16,20,25,40,50,100]:[2,4,5,8,10,20,25,50];
        let d=denominators[Math.floor(Math.random()*denominators.length)];
        let n=Math.floor(Math.random()*(d-1))+1;
        let g=gcd(n,d); n/=g; d/=g;
        const toPercent=Math.random()>0.5;
        const dec=(n/d).toFixed(toPercent?4:3).replace(/0+$/,'').replace(/\.$/,'');
        const pct=((n/d)*100).toFixed(2).replace(/0+$/,'').replace(/\.$/,'')+"%";
        const correct=toPercent?pct:dec;
        const opts=new Set([correct]);
        while(opts.size<4){
          if(toPercent){
            let pn=((n/d)*100+(Math.random()*(diff===3?12:8)-(diff===3?6:4))).toFixed(2).replace(/0+$/,'').replace(/\.$/,'')+"%";
            opts.add(pn);
          } else {
            let dn=(n/d+(Math.random()*0.2-0.1)).toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
            opts.add(dn);
          }
        }
        return {
          question:`Convert ${n}/${d} to a ${toPercent?"percentage":"decimal"}.`,
          correctAnswer:correct,
          options:shuffle([...opts]),
          hint:toPercent?"(fraction × 100)%":"numerator ÷ denominator",
          working:`decimal=${n/d}; percent=${(n/d)*100}%`
        };
      }
      function genProbability(){
        const diff=currentNumericDifficulty();
        const colorsCount=diff===3?4:3;
        const colorNames=["red","blue","green","yellow","purple","black"];
        let picks=[];
        for(let i=0;i<colorsCount;i++) picks.push({c:colorNames[i],v:Math.floor(Math.random()*(diff===3?10:6))+1});
        const target=picks[Math.floor(Math.random()*picks.length)];
        const total=picks.reduce((a,b)=>a+b.v,0);
        const g=gcd(target.v,total);
        const ans=`${target.v/g}/${total/g}`;
        const opts=new Set([ans]);
        while(opts.size<4){
          let nVal=target.v+Math.floor(Math.random()*3-1);
          if(nVal<1) nVal=1;
          let g2=gcd(nVal,total);
          opts.add(`${nVal/g2}/${total/g2}`);
        }
        return {
          question:`Bag: ${picks.map(p=>p.v+" "+p.c).join(", ")}. Probability of ${target.c}? (simplified fraction)`,
          correctAnswer:ans,
            options:shuffle([...opts]),
          hint:"Probability=favourable/total then simplify.",
          working:`Favourable=${target.v}, total=${total} ⇒ ${target.v}/${total} ⇒ ${ans}`
        };
      }
      function genAreaPerimeter(){
        const diff=currentNumericDifficulty();
        const L=Math.floor(Math.random()*(diff===3?30:15))+5;
        const W=Math.floor(Math.random()*(diff===3?20:10))+3;
        const isArea=Math.random()>0.5;
        const ans=isArea?L*W:2*(L+W);
        const opts=new Set([ans]);
        while(opts.size<4){
          let c=ans+Math.floor(Math.random()*(diff===3?31:21)-(diff===3?15:10));
          if(c>0) opts.add(c);
        }
        return {
          question:`${isArea?"Area":"Perimeter"} of rectangle length ${L} cm width ${W} cm?`,
          correctAnswer: ans + (isArea?" cm²":" cm"),
          options: shuffle([...opts]).map(v=>v+(isArea?" cm²":" cm")),
          hint:isArea?"Area = L×W":"Perimeter = 2(L+W)",
          working:isArea?`${L}×${W}=${ans} cm²`:`2(${L}+${W})=2(${L+W})=${ans} cm`
        };
      }
      function genFactorsMultiples(){
        const diff=currentNumericDifficulty();
        const a=Math.floor(Math.random()*(diff===3?40:20))+4;
        const b=Math.floor(Math.random()*(diff===3?40:20))+4;
        function hcf(x,y){return y===0?x:hcf(y,x%y);}
        const h=hcf(a,b);
        const lcm=a*b/h;
        const askLCM=Math.random()>0.5;
        const answer=askLCM?lcm:h;
        const opts=new Set([answer]);
        while(opts.size<4){
          let c=answer+Math.floor(Math.random()*(diff===3?21:11)-(diff===3?10:5));
          if(c>0) opts.add(c);
        }
        return {
          question:`Find the ${askLCM?'LCM':'HCF'} of ${a} and ${b}`,
          correctAnswer:answer.toString(),
          options:shuffle([...opts].map(String)),
          hint:askLCM?"LCM=(a×b)/HCF":"HCF is largest common factor.",
          working:`HCF=${h}, LCM=${lcm}`
        };
      }
      function genPrimeNumber(){
        const diff=currentNumericDifficulty();
        const max=diff===1?40:diff===2?70:120;
        let prime;
        do{prime=Math.floor(Math.random()*max)+11;} while(!isPrime(prime));
        const opts=new Set([prime]);
        while(opts.size<4){
          let c=Math.floor(Math.random()*max)+11;
          if(c!==prime) opts.add(c);
        }
        return {
          question:"Which number is prime?",
          correctAnswer:prime.toString(),
          options:shuffle([...opts].map(String)),
          hint:"Exactly two factors: 1 and itself.",
          working:`Checked divisibility up to √${prime}.`
        };
      }
      function genSolveX(){
        const diff=currentNumericDifficulty();
        const a=Math.floor(Math.random()*(diff===3?15:8))+2;
        const xVal=Math.floor(Math.random()*(diff===3?40:20))+2;
        const b=Math.floor(Math.random()*(diff===3?30:12))-Math.floor(Math.random()*(diff===3?25:6));
        const c=a*xVal+b;
        const opts=new Set([xVal]);
        while(opts.size<4){
          let cand=xVal+Math.floor(Math.random()*(diff===3?11:7)-(diff===3?5:3));
          if(cand!==xVal) opts.add(cand);
        }
        return {
          question:`Solve: ${a}x ${b<0?'- '+(-b):'+ '+b} = ${c}`,
          correctAnswer:xVal.toString(),
          options:shuffle([...opts].map(String)),
          hint:"Isolate x by inverse operations.",
          working:`${a}x=${c-b} ⇒ x=${(c-b)}/${a}=${xVal}`
        };
      }
      function genSpeedDistanceTime(){
        const diff=currentNumericDifficulty();
        const speed=Math.floor(Math.random()*(diff===3?140:diff===2?90:50))+10;
        const time=Math.floor(Math.random()*(diff===3?10:diff===2?6:4))+1;
        const distance=speed*time;
        const mode=["distance","speed","time"][Math.floor(Math.random()*3)];
        let q,ans,unit;
        if(mode==='distance'){q=`A vehicle travels at ${speed} km/h for ${time} h. Distance?`;ans=distance;unit=" km";}
        else if(mode==='speed'){q=`A journey of ${distance} km takes ${time} h. Average speed?`;ans=speed;unit=" km/h";}
        else {q=`A cyclist covers ${distance} km at ${speed} km/h. Time taken?`;ans=time;unit=" h";}
        const opts=new Set([ans]);
        while(opts.size<4){
          let c=ans+Math.floor(Math.random()*(diff===3?31:21)-(diff===3?15:10));
          if(c>0) opts.add(c);
        }
        return {
          question:q,
          correctAnswer:ans+unit,
          options:shuffle([...opts]).map(o=>o+unit),
          hint:"D=ST, S=D/T, T=D/S",
          working:`Given S=${speed}, T=${time}, D=${distance}`
        };
      }
      function genVolumeCuboid(){
        const diff=currentNumericDifficulty();
        const l=Math.floor(Math.random()*(diff===3?20:10))+3;
        const w=Math.floor(Math.random()*(diff===3?15:8))+2;
        const h=Math.floor(Math.random()*(diff===3?15:8))+2;
        const vol=l*w*h;
        const opts=new Set([vol]);
        while(opts.size<4){
          let c=vol+Math.floor(Math.random()*(diff===3?61:31)-(diff===3?30:15));
          if(c>0) opts.add(c);
        }
        return {
          question:`Volume of cuboid: ${l}×${w}×${h}?`,
          correctAnswer:vol+" cm³",
          options:shuffle([...opts]).map(o=>o+" cm³"),
          hint:"Volume = l×w×h.",
          working:`${l}×${w}×${h}=${vol}`
        };
      }
      function genTriangleAngle(){
        const diff=currentNumericDifficulty();
        let a1=Math.floor(Math.random()*(diff===3?100:70))+30;
        let a2=Math.floor(Math.random()*(diff===3?100:70))+20;
        while(a1+a2>=178){
          a1=Math.floor(Math.random()*70)+30;
          a2=Math.floor(Math.random()*70)+20;
        }
        const miss=180-(a1+a2);
        const opts=new Set([miss]);
        while(opts.size<4){
          let c=miss+Math.floor(Math.random()*11-5);
          if(c>0&&c<180) opts.add(c);
        }
        return {
          question:`Triangle angles: ${a1}° and ${a2}°. Third angle?`,
          correctAnswer:miss+"°",
          options:shuffle([...opts]).map(o=>o+"°"),
          hint:"Sum of angles = 180°.",
          working:`180 - (${a1}+${a2}) = ${miss}`
        };
      }

      const GENERATORS = {
        'mean-average-section':genMeanAverage,
        'bearings-section':genBearings,
        'time-section':genTime,
        'ordering-section':genOrdering,
        'decimal-ordering-section':genDecimalOrdering,
        'percentage-discount-section':genPercentageDiscount,
        'reverse-calc-section':genReverseCalc,
        'bodmas-section':genBODMAS,
        'percentage-section':genPercentagePart,
        'angle-section':genAnglePercent,
        'day-week-section':genDayOfWeek,
        'total-bill-section':genTotalBill,
        'temperature-section':genTemperature,
        'number-sequence-section':genNumberSequence,
        'ratio-sharing-section':genRatioSharing,
        'fraction-simplify-section':genFractionSimplify,
        'fraction-of-amount-section':genFractionOfAmount,
        'fraction-convert-section':genFractionConvert,
        'probability-section':genProbability,
        'area-perimeter-section':genAreaPerimeter,
        'factors-multiples-section':genFactorsMultiples,
        'prime-number-section':genPrimeNumber,
        'solve-x-section':genSolveX,
        'speed-distance-time-section':genSpeedDistanceTime,
        'volume-cuboid-section':genVolumeCuboid,
        'triangle-angle-section':genTriangleAngle
      };

      /******************** UI BUILD (remaining sections) ********************/
      function ensureAllCards(){
        const container=document.getElementById('cards-container');
        // We already have mean-average-section as template; generate others
        SECTION_DEFS.slice(1).forEach(def=>{
          if(document.getElementById(def.id)) return;
          const base=document.createElement('div');
          base.className='card';
          base.id=def.id;
          base.innerHTML=`
            <h2>${def.title} <span class="badge" data-diff-tag="${def.id}"></span></h2>
            <span class="time-chip" id="time-${def.id}"></span>
            <div class="question" id="${def.id}-question"></div>
            <div class="options" id="${def.id}-options"></div>
            <div class="hint" id="hint-${def.id}"></div>
            <div class="working" id="working-${def.id}"></div>
            <div class="section-meta" id="meta-${def.id}"></div>
          `;
          container.appendChild(base);
        });
      }

      /******************** QUESTION RENDERING ********************/
      function renderQuestion(sectionId){
        const gen=GENERATORS[sectionId];
        if(!gen) return;
        const data=gen();
        const qObj={
          sectionId,
          ...data,
          options:data.options,
          chosenAnswer:null,
          correct:null,
          startTime: nowMs(),
          answerTime:null,
          elapsedMs:null
        };
        QUESTION_REGISTRY[sectionId]=qObj;
        QUESTION_HISTORY.push(qObj);

        document.getElementById(sectionId+'-question').textContent=data.question;
        const optContainer=document.getElementById(sectionId+'-options');
        optContainer.innerHTML='';
        data.options.forEach(opt=>{
          const btn=document.createElement('button');
          btn.textContent=opt;
          btn.addEventListener('click', ()=>{
            if(!testActive || testFinished) return;
            const ref=QUESTION_REGISTRY[sectionId];
            if(ref.chosenAnswer!==null) return; // already answered
            ref.chosenAnswer=opt;
            ref.answerTime=nowMs();
            ref.elapsedMs=ref.answerTime-ref.startTime;
            btn.classList.add('selected-during-test');
            totalAnswered++;
            updateStatsDisplay();
            // show per-question time chip
            const chip=document.getElementById('time-'+sectionId);
            chip.textContent=humanTime(ref.elapsedMs);
            chip.classList.add('recorded');
          });
          optContainer.appendChild(btn);
        });

        document.getElementById('hint-'+sectionId).textContent=data.hint||'No hint.';
        document.getElementById('working-'+sectionId).textContent=data.working||'No working.';
        // hide meta initially
        const meta=document.getElementById('meta-'+sectionId);
        meta.style.display='none';
        meta.textContent=''; // will fill later
        // classification classes cleared
        const card=document.getElementById(sectionId);
        card.classList.remove('question-correct','question-wrong','question-unanswered');
        const timeChip=document.getElementById('time-'+sectionId);
        timeChip.textContent='';
        timeChip.classList.remove('recorded');
      }

      function generateAllQuestions(){
        QUESTION_HISTORY.length=0;
        Object.keys(QUESTION_REGISTRY).forEach(k=>delete QUESTION_REGISTRY[k]);
        SECTION_DEFS.forEach(def=>renderQuestion(def.id));
        document.getElementById('stat-total').textContent=SECTION_DEFS.length;
      }

      /******************** TEST FLOW ********************/
      function startNewTest(){
        testActive=true;
        testFinished=false;
        totalAnswered=0;
        totalCorrect=0;
        RECENT_RESULTS=[];
        if(difficultyMode!=='adaptive') adaptiveLevel=(difficultyMode==='easy'?1: difficultyMode==='medium'?2:3);
        updateDifficultyStat();
        updateStatsDisplay();
        sessionStorage.clear();
        renderMistakes();
        document.getElementById('finish-banner').style.display='none';
        document.getElementById('finish-summary').textContent='';
        // enable relevant buttons
        document.getElementById('finish-test-btn').disabled=false;
        document.getElementById('show-answers-btn').disabled=true;
        document.getElementById('export-mistakes-btn').disabled=true;
        document.getElementById('export-test-btn').disabled=true;

        generateAllQuestions();
        testStartTime=nowMs();
        startTimer();
      }

      function finishTest(){
        if(!testActive || testFinished) return;
        testFinished=true;
        testActive=false;
        stopTimer();

        // Evaluate correctness now
        SECTION_DEFS.forEach(def=>{
          const q=QUESTION_REGISTRY[def.id];
          if(!q) return;
          if(q.chosenAnswer===null){
            q.correct=false;
            q.elapsedMs = q.elapsedMs ?? (nowMs()-q.startTime);
          } else {
            q.correct = (q.chosenAnswer===q.correctAnswer);
            if(q.correct) totalCorrect++;
            // record mistakes only now
            if(!q.correct){
              saveMistake(q.question, q.chosenAnswer, q.correctAnswer, def.id);
            }
          }
        });

        // Adaptive adjustment after full test
        if(difficultyMode==='adaptive'){
          const acc=totalCorrect/SECTION_DEFS.length;
          if(acc>=0.8 && adaptiveLevel<3) adaptiveLevel++;
          else if(acc<=0.5 && adaptiveLevel>1) adaptiveLevel--;
          document.getElementById('stat-trend').textContent = acc>=0.8?'▲': acc<=0.5?'▼':'→';
        }

        updateDifficultyStat();
        updateStatsDisplay();

        // Allow answer reveal
        document.getElementById('show-answers-btn').disabled=false;
        document.getElementById('finish-test-btn').disabled=true;
        document.getElementById('export-test-btn').disabled=false;
        document.getElementById('export-mistakes-btn').disabled=false;

        // Summary
        const elapsedTotal = nowMs() - testStartTime;
        const summary = `Answered: ${totalAnswered}/${SECTION_DEFS.length}
Correct: ${totalCorrect}
Accuracy: ${SECTION_DEFS.length===0?0:Math.round(100*totalCorrect/SECTION_DEFS.length)}%
Total Time: ${humanTime(elapsedTotal)}
Average Time per Question: ${humanTime(elapsedTotal/SECTION_DEFS.length)}
Click 'Reveal Answers' to see correct answers highlighted.`;
        document.getElementById('finish-summary').textContent=summary;
        document.getElementById('finish-banner').style.display='block';
      }

      function revealAnswers(){
        if(!testFinished) return;
        SECTION_DEFS.forEach(def=>{
          const q=QUESTION_REGISTRY[def.id];
          if(!q) return;
          const optsContainer=document.getElementById(def.id+'-options');
          const buttons=[...optsContainer.querySelectorAll('button')];
          buttons.forEach(b=>{
            b.disabled=true;
            if(b.textContent===q.correctAnswer){
              b.classList.add('correct');
            }
            if(q.chosenAnswer!==null && b.textContent===q.chosenAnswer && q.chosenAnswer!==q.correctAnswer){
              b.classList.add('wrong');
            }
            b.classList.remove('selected-during-test');
          });
          // show meta
            const meta=document.getElementById('meta-'+def.id);
            meta.textContent=`Correct: ${q.correctAnswer} | Your answer: ${q.chosenAnswer===null?'(unanswered)':q.chosenAnswer} | Time: ${humanTime(q.elapsedMs||0)}`;
            meta.style.display='block';

          const card=document.getElementById(def.id);
          card.classList.add(q.chosenAnswer===null?'question-unanswered':(q.correct?'question-correct':'question-wrong'));
          // show time chip (if not)
          const chip=document.getElementById('time-'+def.id);
          chip.textContent=humanTime(q.elapsedMs||0);
          chip.classList.add('recorded');
        });
        document.getElementById('show-answers-btn').disabled=true; // only once
      }

      /******************** MISTAKES ********************/
      function saveMistake(question, chosen, correct, section){
        let mistakes=JSON.parse(sessionStorage.getItem('mistakes')||'[]');
        mistakes.push({section,question,chosen,correct});
        sessionStorage.setItem('mistakes',JSON.stringify(mistakes));
        renderMistakes();
      }
      function renderMistakes(){
        const mistakes=JSON.parse(sessionStorage.getItem('mistakes')||'[]');
        const list=document.getElementById('mistakes-list');
        list.innerHTML='';
        mistakes.forEach((m,i)=>{
          const li=document.createElement('li');
          li.textContent=`${i+1}. [${m.section}] Q: ${m.question} | Your: ${m.chosen} | Correct: ${m.correct}`;
          list.appendChild(li);
        });
      }

      /******************** EXPORT ********************/
      function exportMistakes(){
        const mistakes=JSON.parse(sessionStorage.getItem('mistakes')||'[]');
        if(!mistakes.length){alert('No mistakes.');return;}
        const header="Section,Question,Chosen,Correct\n";
        const csv=header+mistakes.map(m=>`"${m.section}","${m.question.replace(/"/g,'""')}","${m.chosen}","${m.correct}"`).join("\n");
        download(csv,'mistakes.csv','text/csv');
      }
      function exportFullTest(){
        const payload={
          generatedAt:new Date().toISOString(),
          difficultyMode,
          adaptiveLevel,
          totalQuestions:SECTION_DEFS.length,
          totalAnswered,
          totalCorrect,
          accuracy:SECTION_DEFS.length? totalCorrect/SECTION_DEFS.length:0,
          testDurationSeconds: (testStartTime? Math.round((Date.now()-testStartTime)/1000):0),
          questions: SECTION_DEFS.map(def=>{
            const q=QUESTION_REGISTRY[def.id];
            if(!q) return null;
            return {
              sectionId:def.id,
              question:q.question,
              options:q.options,
              correctAnswer:q.correctAnswer,
              chosenAnswer:q.chosenAnswer,
              correct:q.correct,
              hint:q.hint,
              working:q.working,
              timeMs:q.elapsedMs
            };
          }).filter(Boolean)
        };
        download(JSON.stringify(payload,null,2),'full_test.json','application/json');
      }
      function download(content,filename,mime){
        const blob=new Blob([content],{type:mime});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;a.download=filename;document.body.appendChild(a);a.click();
        setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
      }

      /******************** HINT/WORKING TOGGLE ********************/
      function toggleAll(kind){
        document.querySelectorAll(kind==='hint'?'.hint':'.working').forEach(el=>{
          el.style.display = (el.style.display==='block')?'none':'block';
        });
      }

      /******************** EVENTS ********************/
      document.getElementById('difficulty-select').addEventListener('change', e=>{
        difficultyMode=e.target.value;
        if(difficultyMode!=='adaptive') adaptiveLevel=(difficultyMode==='easy'?1: difficultyMode==='medium'?2:3);
        updateDifficultyStat();
      });
      document.getElementById('new-test-btn').addEventListener('click', startNewTest);
      document.getElementById('finish-test-btn').addEventListener('click', finishTest);
      document.getElementById('show-answers-btn').addEventListener('click', revealAnswers);
      document.getElementById('export-mistakes-btn').addEventListener('click', exportMistakes);
      document.getElementById('export-test-btn').addEventListener('click', exportFullTest);
      document.getElementById('toggle-hints-btn').addEventListener('click', ()=>toggleAll('hint'));
      document.getElementById('toggle-workings-btn').addEventListener('click', ()=>toggleAll('working'));
      document.getElementById('clear-score-btn').addEventListener('click', ()=>{
        totalAnswered=0; totalCorrect=0; updateStatsDisplay();
      });

      // Click on any question area to show hint/working toggles individually (optional extension)
      document.addEventListener('click', e=>{
        // Quick hint/working reveal per section (optional future)
      });

      /******************** INITIAL LOAD ********************/
      ensureAllCards();
      updateDifficultyStat();
      updateStatsDisplay();

    </script>
  </body>
  </html>