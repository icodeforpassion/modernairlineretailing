<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airport / City Lookup | Modern Airline Retailing Tools</title>
  <meta name="description" content="Search airports by IATA code, city, or name with fuzzy matching, interactive results, and instant map view.">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <meta name="keywords" content="airport lookup, city search, IATA code, airline tools, map, fuzzy search, travel, aviation">
  <meta property="og:title" content="Airport / City Lookup | Modern Airline Retailing Tools">
  <meta property="og:description" content="Search airports by IATA code, city, or name with fuzzy matching and instant map view.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/airport-lookup">
  <meta property="og:image" content="https://yourdomain.com/og-image.png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <!-- Bulma (for base) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4dMlyFCAsZ3qxEtp2trLI6Rz8pHe9mF+AuA2u9uB+0=" crossorigin="">
  <!-- Google Fonts for cool headings -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Schema.org for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Airport / City Lookup",
    "url": "https://yourdomain.com/airport-lookup",
    "description": "Search airports by IATA code, city, or name with fuzzy matching and map view.",
    "publisher": {
      "@type": "Organization",
      "name": "Modern Airline Retailing Tools"
    }
  }
  </script>
  <style>
    :root {
      --clr-bg: #0d1b2a;
      --clr-bg-alt: #132235;
      --clr-surface: #1f3145;
      --clr-accent: #3298dc;
      --clr-accent-alt: #4fb1f5;
      --clr-text: #e8f0f7;
      --clr-text-dim: #9fb3c5;
      --radius: 14px;
      --focus-ring: 0 0 0 3px rgba(50,152,220,.5);
      --shadow-1: 0 2px 12px rgba(0,0,0,.13);
      --shadow-2: 0 6px 28px -8px rgba(50,152,220,.25);
      --transition: .24s cubic-bezier(.4,.2,.2,1);
      --font-heading: 'Montserrat', 'Inter', system-ui, sans-serif;
      --font-body: 'Inter', system-ui, sans-serif;
    }
    html, body {
      background: var(--clr-bg);
      color: var(--clr-text);
      font-family: var(--font-body);
      min-height: 100vh;
      margin: 0;
    }
    body {
      position: relative;
      overflow-x: hidden;
    }
    .animated-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background: radial-gradient(ellipse at 60% 20%, #3298dc33 0%, #0d1b2a 75%);
      opacity: 0.7;
      animation: bgmove 15s linear infinite alternate;
    }
    @keyframes bgmove {
      0% { background-position: 70% 40%; }
      100% { background-position: 30% 70%; }
    }
    .skip-link {
      position:absolute; left:-999px; top:auto;
      width:1px; height:1px; overflow:hidden;
    }
    .skip-link:focus {
      position:fixed;
      left:1rem; top:1rem;
      width:auto; height:auto;
      padding:.7rem 1rem;
      background:var(--clr-accent);
      color:#fff;
      border-radius:.6rem;
      z-index:1000;
      box-shadow:var(--focus-ring);
    }
    main.tools-wrapper {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding-top: 5.5rem;
      padding-bottom: 4rem;
      min-height: 100vh;
    }
    .lookup-hero {
      text-align:center;
      margin-bottom: 2.5rem;
      max-width: 880px;
      margin-left:auto;
      margin-right:auto;
    }
    .lookup-hero h1 {
      font-family: var(--font-heading);
      font-size: clamp(2.05rem, 5vw, 2.9rem);
      font-weight: 900;
      letter-spacing:.6px;
      background: linear-gradient(90deg,#fff,#c6d9e8 45%,#82bfe7);
      -webkit-background-clip:text;
      color:transparent;
      margin-bottom:.7rem;
      text-shadow: 0 2px 10px #3298dc22;
    }
    .lookup-hero p {
      color: var(--clr-text-dim);
      font-size:1.11rem;
      line-height:1.5;
      max-width:680px;
      margin:0 auto 1.2rem;
      font-family: var(--font-body);
    }
    .lookup-panel {
      position: relative;
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr 420px;
    }
    @media (max-width: 980px){
      .lookup-panel { grid-template-columns: 1fr; }
    }
    .surface-card {
      background: linear-gradient(165deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow-1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }
    .surface-card:hover {
      border-color: var(--clr-accent-alt);
      box-shadow: var(--shadow-2);
    }
    .lookup-card {
      padding: 1.6rem 1.6rem 2.1rem;
    }
    .lookup-fieldwrap {
      position: relative;
      margin-bottom: 1.15rem;
    }
    .lookup-label {
      font-size:.68rem;
      letter-spacing:.55px;
      font-weight:600;
      text-transform:uppercase;
      color: var(--clr-text-dim);
      display:block;
      margin-bottom:.45rem;
      font-family: var(--font-body);
    }
    .lookup-input {
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.15);
      color: var(--clr-text);
      font-size:1rem;
      line-height:1.25;
      padding:.85rem 1.05rem .85rem 2.7rem;
      border-radius: 999px;
      transition: var(--transition);
      font-family: var(--font-body);
      backdrop-filter: blur(4px);
    }
    .lookup-input:focus {
      outline:none;
      border-color: var(--clr-accent-alt);
      box-shadow: var(--focus-ring);
      background: rgba(255,255,255,.10);
    }
    .lookup-icon {
      position:absolute;
      top:50%;
      left:1rem;
      transform:translateY(-50%);
      font-size:1.15rem;
      pointer-events:none;
      color: var(--clr-text-dim);
      transition: var(--transition);
    }
    .lookup-fieldwrap:focus-within .lookup-icon {
      color: var(--clr-accent-alt);
    }
    .actions-row {
      display:flex;
      gap:.65rem;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:.4rem;
    }
    .btn-primary-gradient {
      background: linear-gradient(135deg, var(--clr-accent) 0%, var(--clr-accent-alt) 100%);
      color:#fff;
      border:none;
      font-weight:700;
      letter-spacing:.3px;
      padding:.75rem 1.25rem;
      border-radius:999px;
      cursor:pointer;
      font-size:1rem;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      position:relative;
      box-shadow:0 6px 18px -4px rgba(50,152,220,.55), 0 2px 3px -1px rgba(0,0,0,.55);
      transition:var(--transition);
      font-family: var(--font-heading);
    }
    .btn-primary-gradient:hover {
      transform:translateY(-3px);
      box-shadow:0 10px 28px -6px rgba(50,152,220,.6), 0 3px 5px -2px rgba(0,0,0,.55);
      background: var(--clr-accent-alt);
      color:#082032;
    }
    .btn-primary-gradient:active { transform: translateY(-1px); }
    .btn-primary-gradient:focus-visible { outline:none; box-shadow: var(--focus-ring); }
    .btn-primary-gradient[disabled] {
      opacity:.55;
      cursor:progress;
      transform:none;
      box-shadow:0 2px 6px -2px rgba(0,0,0,.4);
    }
    .btn-soft {
      background: rgba(79,177,245,.13);
      color:#cfeafe;
      border:1px solid rgba(79,177,245,.30);
      padding:.62rem 1rem;
      font-size:.85rem;
      border-radius:.75rem;
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      font-weight:600;
      letter-spacing:.4px;
      cursor:pointer;
      transition:var(--transition);
      font-family: var(--font-heading);
    }
    .btn-soft:hover {
      background: var(--clr-accent-alt);
      color:#082032;
      border-color: var(--clr-accent-alt);
      box-shadow:0 4px 14px -4px rgba(79,177,245,.6);
    }
    .btn-soft:focus-visible { outline:none; box-shadow: var(--focus-ring); }
    #status {
      margin-top:.4rem;
      font-size:.68rem;
      letter-spacing:.5px;
      font-weight:600;
      text-transform:uppercase;
      color:var(--clr-text-dim);
      min-height:1.1em;
      font-family: var(--font-heading);
    }
    #status.error { color:#ff9393; }
    .results-wrapper {
      margin-top:1.4rem;
      display:flex;
      flex-direction:column;
      gap:.95rem;
      position:relative;
    }
    .result-item {
      position:relative;
      padding: .85rem 1rem .9rem 1rem;
      background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.09);
      border-radius: calc(var(--radius) - 6px);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:.3rem;
      transition: var(--transition);
      outline:none;
      font-family: var(--font-body);
    }
    .result-item:hover, .result-item[aria-selected="true"] {
      border-color: var(--clr-accent-alt);
      background: linear-gradient(160deg, rgba(79,177,245,.18), rgba(255,255,255,.05));
      box-shadow:0 3px 10px -2px rgba(79,177,245,.4);
      transform:translateY(-3px);
    }
    .result-item:active {
      transform:translateY(-1px);
    }
    .result-item strong {
      font-weight:700;
      letter-spacing:.4px;
      color:#fff;
      font-family: var(--font-heading);
    }
    .result-line {
      display:flex;
      flex-wrap:wrap;
      gap:.45rem .9rem;
      align-items:baseline;
      font-size:.95rem;
      line-height:1.2;
      color:var(--clr-text-dim);
    }
    .result-meta {
      font-size:.75rem;
      letter-spacing:.55px;
      text-transform:uppercase;
      color: var(--clr-text-dim);
      display:flex;
      gap:.8rem;
      flex-wrap:wrap;
      align-items:center;
      font-family: var(--font-heading);
    }
    .score-pill {
      background:rgba(13,27,42,.75);
      border:1px solid rgba(255,255,255,.15);
      font-size:.7rem;
      font-weight:700;
      padding:.3rem .55rem;
      border-radius:999px;
      letter-spacing:.5px;
      color:#cfeafe;
      backdrop-filter:blur(6px);
      font-family: var(--font-heading);
    }
    .copy-indicator {
      font-size:.62rem;
      letter-spacing:.5px;
      text-transform:uppercase;
      color: var(--clr-accent-alt);
      display:none;
      font-weight:700;
      font-family: var(--font-heading);
    }
    .result-item.copied .copy-indicator { display:inline; }
    mark {
      background: rgba(79,177,245,.35);
      color:#fff;
      padding:0 3px;
      border-radius:4px;
    }
    .empty-hint {
      font-size:.9rem;
      color: var(--clr-text-dim);
      padding:.6rem .2rem;
      font-family: var(--font-heading);
    }
    .map-card {
      padding: 1.15rem 1.15rem 1.3rem;
      display:flex;
      flex-direction:column;
      gap:.85rem;
      font-family: var(--font-body);
    }
    .map-card header {
      font-size:.68rem;
      font-weight:700;
      letter-spacing:.55px;
      text-transform:uppercase;
      color:var(--clr-text-dim);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family: var(--font-heading);
    }
    .map-frame {
      width:100%;
      height:420px;
      border:1px solid rgba(255,255,255,.14);
      border-radius: calc(var(--radius) - 6px);
      background:#0d1b2a;
      overflow:hidden;
      position:relative;
    }
    #lookupMap {
      inset:0;
      position:absolute;
    }
    @media (max-width: 600px){
      .map-frame { height:320px; }
      .lookup-card, .map-card { padding: 1rem 0.7rem 1.2rem; }
      .lookup-panel { gap: 1.2rem; }
    }
    .spinner {
      width:16px; height:16px;
      border:2px solid rgba(255,255,255,.55);
      border-right-color:#fff;
      border-radius:50%;
      animation:spin .65s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .skeleton-block {
      background: linear-gradient(90deg, #1e3044 0%, #263d55 45%, #1e3044 90%);
      background-size:200% 100%;
      animation: shimmer 2.4s linear infinite;
      border-radius: .6rem;
      height:60px;
      border:1px solid rgba(255,255,255,.08);
    }
    .skeleton-grid {
      display:grid;
      gap:.85rem;
    }
    @keyframes shimmer {
      0% { background-position:200% 0; }
      100% { background-position:-200% 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      .result-item,
      .btn-primary-gradient,
      .btn-soft,
      .surface-card,
      .lookup-input {
        transition:none !important;
        transform:none !important;
      }
      .skeleton-block { animation:none; }
    }
  </style>
  <link rel="stylesheet" href="/assets/site.css"/>
</head>
<body>
  <header class="site-header"></header>
  <div class="page-content">
  <div class="animated-bg"></div>
  <a href="#main" class="skip-link">Skip to content</a>
  <main id="main" class="tools-wrapper">
    <section class="lookup-hero">
      <h1>Airport / City Lookup</h1>
      <p>Type an IATA code (e.g. <b>LHR</b>), a city (<b>Dubai</b>), or part of an airport name. Fuzzy matching tolerates small typos. Select a result to view map location. 
        <br><span style="color:var(--clr-accent-alt);font-weight:600;">Fast, accurate</span>
      </p>
    </section>
    <section class="lookup-panel">
      <!-- Left: Search & Results -->
      <div class="surface-card lookup-card" id="searchCard">
        <form id="lookupForm" novalidate autocomplete="off">
          <label class="lookup-label" for="lookupInput">Search Query</label>
            <div class="lookup-fieldwrap">
              <span class="lookup-icon" aria-hidden="true">🔍</span>
              <input
                id="lookupInput"
                class="lookup-input"
                name="q"
                type="text"
                placeholder="Try: JFK, Singapore, Doha, San"
                autocomplete="off"
                aria-describedby="status"
                aria-label="Airport search input"
                role="combobox"
                aria-expanded="false"
                aria-owns="resultsList"
                aria-autocomplete="list">
            </div>
          <div class="actions-row">
            <button type="submit" id="searchBtn" class="btn-primary-gradient">
              <span>Search</span>
              <span class="btn-spinner-slot" aria-hidden="true"></span>
            </button>
            <button type="button" id="clearBtn" class="btn-soft" title="Clear input">
              Clear
            </button>
            <button type="button" id="randomBtn" class="btn-soft" title="Random airport">
              Random
            </button>
          </div>
          <div id="status" role="status" aria-live="polite"></div>
        </form>
        <div id="resultsRegion" class="results-wrapper" aria-label="Search results">
          <div id="skeletonContainer" class="skeleton-grid" style="display:none;">
            <div class="skeleton-block"></div>
            <div class="skeleton-block"></div>
            <div class="skeleton-block"></div>
          </div>
          <div id="resultsList" role="listbox"></div>
        </div>
        <noscript>
          <p class="empty-hint" style="margin-top:1rem;">Enable JavaScript to use the interactive lookup.</p>
        </noscript>
      </div>
      <!-- Right: Map -->
      <aside class="surface-card map-card" aria-label="Map panel">
        <header>
          <span>Map View</span>
          <span id="mapInfo" style="font-size:.6rem; letter-spacing:.5px; color:var(--clr-text-dim);"></span>
        </header>
        <div class="map-frame">
          <div id="lookupMap" aria-hidden="true"></div>
        </div>
        <p style="font-size:.7rem; color:var(--clr-text-dim); line-height:1.4;">
          Selecting a result will focus this map around the airport. Data source: OpenStreetMap.
        </p>
      </aside>
    </section>
  </main>
  </div>

  <footer class="site-footer"></footer>
  <script src="/assets/site.js" defer></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-1A+0+ZKU6Nwf35p3xNmPR9U1FVLtZLgm52r3yAqoMWU=" crossorigin=""></script>
  <script>
    (function(){
      'use strict';

      const DATA_URL = '/tools/airports.json';
      const MAX_RESULTS = 20;
      const MAP_DEFAULT_VIEW = [20, 0];
      const MAP_DEFAULT_ZOOM = 2;
      const MAP_FOCUS_ZOOM = 7;

      const input = document.getElementById('lookupInput');
      const form = document.getElementById('lookupForm');
      const statusEl = document.getElementById('status');
      const resultsList = document.getElementById('resultsList');
      const skeletonContainer = document.getElementById('skeletonContainer');
      const searchBtn = document.getElementById('searchBtn');
      const btnSpinnerSlot = searchBtn ? searchBtn.querySelector('.btn-spinner-slot') : null;
      const clearBtn = document.getElementById('clearBtn');
      const randomBtn = document.getElementById('randomBtn');
      const mapCanvas = document.getElementById('lookupMap');
      const mapInfo = document.getElementById('mapInfo');
      const urlParams = new URLSearchParams(window.location.search);

      let airports = [];
      let normalized = [];
      let currentResults = [];
      let loadingPromise = null;
      let activeIndex = -1;
      let debounceHandle = null;
      let mapInstance = null;
      let mapMarker = null;

      function normalize(str) {
        return (str || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toUpperCase()
          .trim();
      }

      function escapeHTML(value) {
        return (value || '').replace(/[&<>'"]/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[char]);
      }

      function highlight(text, query) {
        if (!query) return escapeHTML(text);
        const escaped = query.replace(/[.*+?^${}()|[\]\]/g, '\$&');
        return escapeHTML(text).replace(new RegExp(`(${escaped})`, 'ig'), '<mark>$1</mark>');
      }

      function formatMeta(airport) {
        const parts = [];
        if (airport.city) parts.push(airport.city);
        if (airport.country) parts.push(airport.country);
        return parts.join(', ');
      }

      function setStatus(message, isError = false) {
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.classList.toggle('error', Boolean(isError));
      }

      function initializeMap() {
        if (!mapCanvas || !window.L) return;
        mapInstance = L.map(mapCanvas, {
          worldCopyJump: true,
          scrollWheelZoom: false,
          zoomControl: false
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapInstance);
        mapInstance.setView(MAP_DEFAULT_VIEW, MAP_DEFAULT_ZOOM);
        requestAnimationFrame(() => {
          mapInstance.invalidateSize();
        });
      }

      function resetMap(message = 'Pick a result to preview it on the map.') {
        if (mapInfo) {
          mapInfo.textContent = message;
        }
        if (!mapInstance) return;
        if (mapMarker) {
          mapInstance.removeLayer(mapMarker);
          mapMarker = null;
        }
        mapInstance.setView(MAP_DEFAULT_VIEW, MAP_DEFAULT_ZOOM);
      }

      function setLoading(loading) {
        if (searchBtn) {
          searchBtn.disabled = loading;
        }
        if (btnSpinnerSlot) {
          btnSpinnerSlot.innerHTML = loading ? '<span class="spinner" aria-hidden="true"></span>' : '';
        }
        if (skeletonContainer) {
          skeletonContainer.style.display = loading ? 'grid' : 'none';
        }
      }

      function levenshtein(a, b) {
        if (a === b) return 0;
        const al = a.length;
        const bl = b.length;
        if (!al) return bl;
        if (!bl) return al;
        const prev = new Array(bl + 1);
        const curr = new Array(bl + 1);
        for (let j = 0; j <= bl; j++) prev[j] = j;
        for (let i = 0; i < al; i++) {
          curr[0] = i + 1;
          for (let j = 0; j < bl; j++) {
            const cost = a[i] === b[j] ? 0 : 1;
            curr[j + 1] = Math.min(curr[j] + 1, prev[j + 1] + 1, prev[j] + cost);
          }
          for (let j = 0; j <= bl; j++) prev[j] = curr[j];
        }
        return curr[bl];
      }

      function scoreAirport(entry, query) {
        if (!query) return 0;
        let score = 0;
        if (entry.code === query) return 250;
        if (entry.code.startsWith(query)) score = Math.max(score, 200);
        if (entry.city === query || entry.name === query) score = Math.max(score, 180);
        if (entry.city.startsWith(query) || entry.name.startsWith(query)) score = Math.max(score, 160);
        if (entry.city.includes(query) || entry.name.includes(query)) score = Math.max(score, 140);
        if (entry.code.includes(query)) score = Math.max(score, 130);

        if (query.length >= 3) {
          const codeDistance = levenshtein(entry.code, query);
          if (codeDistance > 0 && codeDistance <= 2) {
            score = Math.max(score, 120 - codeDistance * 10);
          }
          if (entry.city) {
            const cityDistance = levenshtein(entry.city.slice(0, query.length + 2), query);
            if (cityDistance <= 2) score = Math.max(score, 112 - cityDistance * 8);
          }
          if (entry.name) {
            const nameDistance = levenshtein(entry.name.slice(0, query.length + 2), query);
            if (nameDistance <= 2) score = Math.max(score, 108 - nameDistance * 6);
          }
        }
        return score;
      }

      async function loadAirports() {
        if (loadingPromise) return loadingPromise;
        loadingPromise = (async () => {
          setLoading(true);
          try {
            const response = await fetch(DATA_URL, { cache: 'no-store' });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const list = Array.isArray(data)
              ? data
              : Object.keys(data).map(code => ({ code, ...(data[code] || {}) }));
            airports = list.filter(item => item && item.code);
            normalized = airports.map(item => ({
              airport: item,
              code: normalize(item.code),
              city: normalize(item.city),
              name: normalize(item.name)
            }));
            setStatus('Data loaded. Start typing to search.');
          } catch (error) {
            setStatus(`Failed to load airport data: ${error.message}`, true);
            throw error;
          } finally {
            setLoading(false);
          }
          return airports;
        })();
        return loadingPromise;
      }

      function updateActiveVisual() {
        const items = resultsList ? resultsList.querySelectorAll('.result-item') : [];
        items.forEach((item, index) => {
          const isActive = index === activeIndex;
          item.classList.toggle('is-active-temp', isActive);
          item.setAttribute('aria-selected', String(isActive));
          if (isActive) {
            item.focus({ preventScroll: true });
          }
        });
      }

      function renderResults(results, rawQuery) {
        if (!resultsList) return;
        resultsList.innerHTML = '';
        activeIndex = -1;
        currentResults = results;
        if (!results.length) {
          resultsList.innerHTML = '<div class="empty-hint" role="note">No matches. Try another spelling or city.</div>';
          input.setAttribute('aria-expanded', 'false');
          return;
        }
        const fragment = document.createDocumentFragment();
        results.forEach((entry, index) => {
          const { airport } = entry;
          const node = document.createElement('div');
          node.className = 'result-item';
          node.setAttribute('role', 'option');
          node.setAttribute('data-index', String(index));
          node.tabIndex = -1;
          const meta = formatMeta(airport);
          node.innerHTML = `
            <div class="result-line">
              <strong>${highlight(airport.code, rawQuery)}</strong>
              <span>${highlight(airport.name || '', rawQuery)}</span>
            </div>
            <div class="result-meta">
              <span>${highlight(meta, rawQuery)}</span>
              <span class="score-pill" title="Match score">${entry.score}</span>
              <span class="copy-indicator" aria-hidden="true">Copied</span>
            </div>
          `;
          node.addEventListener('click', () => selectResult(index));
          node.addEventListener('keydown', event => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              selectResult(index);
            }
          });
          fragment.appendChild(node);
        });
        resultsList.appendChild(fragment);
        input.setAttribute('aria-expanded', 'true');
      }

      function selectResult(index) {
        const entry = currentResults[index];
        if (!entry) return;
        activeIndex = index;
        updateActiveVisual();
        const airport = entry.airport;
        focusMap(airport);
        setStatus(`${airport.name || airport.code} (${airport.code}) selected.`);
        copyCode(airport.code);
        updateQueryParam(airport.code);
      }

      function copyCode(code) {
        const items = resultsList ? resultsList.querySelectorAll('.result-item') : [];
        items.forEach(item => item.classList.remove('copied'));
        const active = items[activeIndex];
        if (active) {
          active.classList.add('copied');
          setTimeout(() => active.classList.remove('copied'), 1400);
        }
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(code).catch(() => {});
      }

      function updateQueryParam(value) {
        const url = new URL(window.location.href);
        if (value) {
          url.searchParams.set('q', value);
        } else {
          url.searchParams.delete('q');
        }
        window.history.replaceState({}, '', url.toString());
      }

      function focusMap(airport) {
        if (!mapInstance || !mapInfo) return;
        if (typeof airport.lat !== 'number' || typeof airport.lon !== 'number') {
          resetMap('No coordinates available');
          return;
        }
        const { lat, lon } = airport;
        if (mapMarker) {
          mapInstance.removeLayer(mapMarker);
        }
        mapMarker = L.marker([lat, lon], {
          title: `${airport.code} ${airport.name || ''}`.trim()
        });
        mapMarker.addTo(mapInstance);
        mapInstance.flyTo([lat, lon], MAP_FOCUS_ZOOM, {
          duration: 0.6
        });
        mapInfo.textContent = `${airport.code} • ${airport.name || ''}`.trim();
      }

      function runSearch(fromInput = false) {
        const rawQuery = input.value.trim();
        const query = normalize(rawQuery);
        if (!query) {
          currentResults = [];
          if (resultsList) {
            resultsList.innerHTML = '';
          }
          input.setAttribute('aria-expanded', 'false');
          setStatus('Type an airport code, city or name to search.');
          return currentResults;
        }
        const scored = normalized
          .map(entry => ({ ...entry, score: scoreAirport(entry, query) }))
          .filter(entry => entry.score > 0)
          .sort((a, b) => b.score - a.score)
          .slice(0, MAX_RESULTS);
        renderResults(scored, rawQuery);
        if (scored.length) {
          setStatus(`Found ${scored.length} matching airports.`);
          if (fromInput && scored[0].code === query) {
            activeIndex = 0;
            updateActiveVisual();
          }
        } else {
          setStatus('No matches found.', true);
        }
        return currentResults;
      }

      function handleArrowNavigation(event) {
        const items = resultsList ? resultsList.querySelectorAll('.result-item') : [];
        if (!items.length) return;
        if (event.key === 'ArrowDown') {
          event.preventDefault();
          activeIndex = (activeIndex + 1) % items.length;
          updateActiveVisual();
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          activeIndex = (activeIndex - 1 + items.length) % items.length;
          updateActiveVisual();
        } else if (event.key === 'Enter') {
          if (activeIndex >= 0) {
            event.preventDefault();
            selectResult(activeIndex);
          }
        }
      }

      function clearResults() {
        input.value = '';
        currentResults = [];
        activeIndex = -1;
        if (resultsList) {
          resultsList.innerHTML = '';
        }
        input.setAttribute('aria-expanded', 'false');
        setStatus('Cleared. Type to search again.');
        resetMap();
        input.focus();
        updateQueryParam('');
      }

      async function handleRandom() {
        await loadAirports().catch(() => {});
        if (!airports.length) return;
        const random = airports[Math.floor(Math.random() * airports.length)];
        input.value = random.code;
        runSearch();
        if (currentResults.length) {
          selectResult(0);
        }
      }

      function applyInitialQuery() {
        if (!input) return;
        const initialQuery = urlParams.get('q');
        if (!initialQuery) return;
        input.value = initialQuery;
        const results = runSearch();
        if (!results.length) {
          setStatus(`No matches found for "${initialQuery.toUpperCase()}".`, true);
          return;
        }
        const exactIndex = results.findIndex(entry => entry.airport.code.toUpperCase() === initialQuery.toUpperCase());
        selectResult(exactIndex >= 0 ? exactIndex : 0);
      }

      if (resultsList) {
        resultsList.addEventListener('click', event => {
          const target = event.target.closest('.result-item');
          if (!target) return;
          const index = Number(target.getAttribute('data-index'));
          selectResult(index);
        });
      }

      if (form) {
        form.addEventListener('submit', event => {
          event.preventDefault();
          loadAirports().then(() => runSearch()).catch(() => {});
        });
      }

      if (input) {
        input.addEventListener('input', () => {
          clearTimeout(debounceHandle);
          debounceHandle = setTimeout(() => {
            loadAirports().then(() => runSearch(true)).catch(() => {});
          }, 220);
        });
        input.addEventListener('keydown', handleArrowNavigation);
      }

      if (resultsList) {
        resultsList.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            const target = event.target.closest('.result-item');
            if (!target) return;
            event.preventDefault();
            const index = Number(target.getAttribute('data-index'));
            selectResult(index);
          } else if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
            handleArrowNavigation(event);
          }
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener('click', clearResults);
      }

      if (randomBtn) {
        randomBtn.addEventListener('click', handleRandom);
      }

      initializeMap();
      resetMap();

      loadAirports()
        .then(() => {
          applyInitialQuery();
        })
        .catch(() => {});
    })();
  </script>
</body>
</html>
