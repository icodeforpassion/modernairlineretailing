<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Great Circle Distance Calculator</title>
  <meta name="description" content="Find the distance between any two cities or airports instantly.">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <style>
    :root {
      --clr-bg: #0d1b2a;
      --clr-bg-alt: #132235;
      --clr-surface: #1f3145;
      --clr-accent: #3298dc;
      --clr-accent-alt: #4fb1f5;
      --clr-text: #e8f0f7;
      --clr-text-dim: #9fb3c5;
      --radius: 14px;
      --transition: .24s cubic-bezier(.4,.2,.2,1);
      --focus-ring: 0 0 0 3px rgba(50,152,220,.5);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background: var(--clr-bg); color: var(--clr-text); }
    main { max-width: 900px; margin: auto; padding: 2rem 1rem; }
    h1 { font-size: 2.2rem; margin-bottom: 1.5rem; text-align: center; }
    
    .form-box { background: var(--clr-surface); border-radius: var(--radius); padding: 2rem 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,.13); }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
    .input-group { flex: 1 1 200px; display: flex; flex-direction: column; position: relative; }
    label { font-size: .95em; font-weight: 600; margin-bottom: .3em; color: var(--clr-text-dim); }
    input[type="text"] { width: 100%; font-size: 1.1em; padding: .8em 1em; border-radius: 8px; border: 1px solid var(--clr-accent-alt); background: rgba(255,255,255,.07); color: var(--clr-text); transition: var(--transition); }
    input[type="text"]:focus { outline: none; box-shadow: var(--focus-ring); border-color: var(--clr-accent); }
    .swap-btn { background: var(--clr-accent); color: #fff; border: none; border-radius: 8px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; transition: background .15s; margin-bottom: 0.3em; margin-top: 1.7em; }
    .swap-btn:hover { background: var(--clr-accent-alt); }
    .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: var(--clr-bg-alt); color: var(--clr-text); border: 1px solid var(--clr-accent-alt); border-top: none; border-radius: 0 0 10px 10px; z-index: 100; max-height: 210px; overflow-y: auto; box-shadow: 0 8px 24px -8px rgba(0,0,0,.45); margin-top: 2px; }
    .autocomplete-item { padding: .7em 1em; cursor: pointer; font-size: 1em; border-bottom: 1px solid var(--clr-surface); }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover, .autocomplete-item.active { background: var(--clr-accent-alt); color: #082032; }

    .results-box { background: var(--clr-bg-alt); border-radius: var(--radius); padding: 1.5rem 1.2rem; margin-top: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,.10); }
    .metrics { display: grid; gap: 1.2rem; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    .metric { background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.09); padding: 1rem 1.05rem; border-radius: 10px; text-align: center; }
    .metric h3 { font-size: .85em; font-weight: 700; color: var(--clr-text-dim); margin: 0 0 .2em 0; }
    .metric .value { font-size: 1.1em; font-weight: 600; color: #fff; word-break: break-word; }
    #map { width: 100%; height: 350px; border-radius: 10px; margin-top: 1.5rem; border: 1px solid var(--clr-accent-alt); }

    .status-bar { margin-top: .4em; font-size: .95em; color: var(--clr-accent-alt); }
    .popular-links { margin-top: 1.4em; text-align: center; }
    .popular-links a { color: var(--clr-accent-alt); margin: 0 0.6em; text-decoration: underline; }

    @media(max-width: 700px){
      .form-row { flex-direction: column; align-items: stretch; }
      .swap-btn { width: 100%; margin: 0.6em 0 0.3em 0; height: 44px; font-size: 1.2em; }
      .metrics { grid-template-columns: 1fr; }
      input[type="text"] { font-size: 1em; padding: .7em; }
    }
  </style>
</head>
<body>
<main>
  <h1>Great Circle Distance Calculator</h1>
  <div class="form-box">
    <form id="gcForm" autocomplete="off" spellcheck="false">
      <div class="form-row">
        <div class="input-group">
          <label for="origin">Origin (City or Airport)</label>
          <input id="origin" type="text" placeholder="e.g. London or LHR">
          <div class="autocomplete-list" id="origin-autocomplete" style="display:none;"></div>
        </div>
        <button type="button" class="swap-btn" id="swapBtn" title="Swap origin & destination">⇅</button>
        <div class="input-group">
          <label for="destination">Destination (City or Airport)</label>
          <input id="destination" type="text" placeholder="e.g. Dubai or DXB">
          <div class="autocomplete-list" id="destination-autocomplete" style="display:none;"></div>
        </div>
      </div>
      <div class="status-bar" id="status" role="status" aria-live="polite"></div>
    </form>
    <div class="popular-links">
      Popular: 
      <a href="?from=london&to=dubai">London → Dubai</a>
      <a href="?from=trivandrum&to=kul">Trivandrum → KUL</a>
      <a href="?from=new+york&to=paris">New York → Paris</a>
    </div>
  </div>

  <div class="results-box" id="results" style="display:none;">
    <div class="metrics">
      <div class="metric">
        <h3>Distance</h3>
        <div class="value" id="distMain">—</div>
      </div>
      <div class="metric">
        <h3>Bearings</h3>
        <div class="value"><span id="bearInit">—</span> → <span id="bearFinal">—</span></div>
      </div>
      <div class="metric">
        <h3>Midpoint</h3>
        <div class="value" id="midpoint">—</div>
      </div>
      <div class="metric">
        <h3>Approx Flight Time</h3>
        <div class="value" id="flightTime">—</div>
      </div>
    </div>
    <div id="map" aria-label="Great circle route map"></div>
  </div>
</main>

<script>
// ---- LOAD AIRPORT DATA ----
let airportList = [], dataLoaded = false;
fetch('/airports.json').then(r=>r.json()).then(data=>{
  airportList = Object.values(data).map(a => ({
    ...a,
    searchKey: `${a.code} ${a.city} ${a.name} ${a.country}`.toLowerCase()
  }));
  dataLoaded = true;
  prefillFromURL();
}).catch(()=>{
  // fallback minimal
  airportList = [
    {code:"TRV", city:"Trivandrum", name:"Trivandrum Intl", country:"India", lat:8.4821, lon:76.9207, searchKey:"trv trivandrum trivandrum intl india"},
    {code:"KUL", city:"Kuala Lumpur", name:"Kuala Lumpur Intl", country:"Malaysia", lat:2.7456, lon:101.7072, searchKey:"kul kuala lumpur kuala lumpur intl malaysia"}
  ];
  dataLoaded = true;
});

// ---- AUTOCOMPLETE ----
function findAirports(q) {
  q = q.trim().toLowerCase();
  if(!q || !airportList.length) return [];
  return airportList.filter(a=>a.searchKey.includes(q)).slice(0,8);
}
function showAutocomplete(input, listEl) {
  const val = input.value;
  const matches = findAirports(val);
  if(matches.length===0){ listEl.style.display='none'; return; }
  listEl.innerHTML = matches.map(a=>`
    <div class="autocomplete-item" data-code="${a.code}"><strong>${a.code}</strong> - ${a.city}, ${a.country}</div>
  `).join('');
  listEl.style.display='block';
  Array.from(listEl.children).forEach(item=>{
    item.onclick = ()=>{
      input.value = item.dataset.code;
      listEl.style.display='none';
      computeResults();
    };
  });
}
document.getElementById('origin').addEventListener('input', ()=>showAutocomplete(document.getElementById('origin'), document.getElementById('origin-autocomplete')));
document.getElementById('destination').addEventListener('input', ()=>showAutocomplete(document.getElementById('destination'), document.getElementById('destination-autocomplete')));
document.getElementById('origin').addEventListener('blur', ()=>setTimeout(()=>document.getElementById('origin-autocomplete').style.display='none',120));
document.getElementById('destination').addEventListener('blur', ()=>setTimeout(()=>document.getElementById('destination-autocomplete').style.display='none',120));

// Swap
document.getElementById('swapBtn').onclick = ()=>{
  const o = document.getElementById('origin').value;
  const d = document.getElementById('destination').value;
  document.getElementById('origin').value = d;
  document.getElementById('destination').value = o;
  computeResults();
};

// Haversine, bearings, midpoint
function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371.0088;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function initialBearing(lat1, lon1, lat2, lon2){
  const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}
function finalBearing(lat1, lon1, lat2, lon2){ return (initialBearing(lat2, lon2, lat1, lon1)+180)%360; }
function midpoint(lat1, lon1, lat2, lon2){
  const φ1=toRad(lat1), λ1=toRad(lon1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
  const Bx=Math.cos(φ2)*Math.cos(Δλ), By=Math.cos(φ2)*Math.sin(Δλ);
  const φ3=Math.atan2(Math.sin(φ1)+Math.sin(φ2), Math.sqrt((Math.cos(φ1)+Bx)**2+By**2));
  const λ3=λ1+Math.atan2(By,Math.cos(φ1)+Bx);
  return {lat:toDeg(φ3), lon:((toDeg(λ3)+540)%360)-180};
}
function formatBearing(b){ return b==null?'—':b.toFixed(1)+'°'; }
function formatDistance(km){ return km==null?'—':km.toFixed(2)+' km'; }
function formatFlightTime(km){ if(km==null) return '—'; const hours=(km*0.5399568)/450; const h=Math.floor(hours), m=Math.round((hours-h)*60); return `${h}h ${String(m).padStart(2,'0')}m`; }

// Compute results
function computeResults() {
  if(!dataLoaded) return;
  const oVal=document.getElementById('origin').value.trim().toUpperCase();
  const dVal=document.getElementById('destination').value.trim().toUpperCase();
  const o=airportList.find(a=>a.code.toUpperCase()===oVal||a.city.toUpperCase()===oVal);
  const d=airportList.find(a=>a.code.toUpperCase()===dVal||a.city.toUpperCase()===dVal);
  const status=document.getElementById('status');
  if(!o||!d){ status.textContent="Please select valid airports or cities from the list."; document.getElementById('results').style.display='none'; return; }
  if(o.code===d.code){ status.textContent="Origin and destination are the same."; document.getElementById('results').style.display='none'; return; }
  status.textContent="";
  const distKm=haversineKm(o.lat,o.lon,d.lat,d.lon);
  const ib=initialBearing(o.lat,o.lon,d.lat,d.lon);
  const fb=finalBearing(o.lat,o.lon,d.lat,d.lon);
  const mid=midpoint(o.lat,o.lon,d.lat,d.lon);
  document.getElementById('distMain').textContent=formatDistance(distKm);
  document.getElementById('bearInit').textContent=formatBearing(ib);
  document.getElementById('bearFinal').textContent=formatBearing(fb);
  document.getElementById('midpoint').textContent=`${mid.lat.toFixed(3)}, ${mid.lon.toFixed(3)}`;
  document.getElementById('flightTime').textContent=formatFlightTime(distKm);
  document.getElementById('results').style.display='block';
  drawMap(o.lat,o.lon,d.lat,d.lon);
}

// Listen for change
document.getElementById('origin').addEventListener('change', computeResults);
document.getElementById('destination').addEventListener('change', computeResults);

// Pre-fill from URL
function prefillFromURL() {
  const params=new URLSearchParams(window.location.search);
  const from=params.get('from'), to=params.get('to');
  if(from) document.getElementById('origin').value=from;
  if(to) document.getElementById('destination').value=to;
  if(from && to) computeResults();
}

// Minimal Leaflet map
function drawMap(lat1, lon1, lat2, lon2) {
  if(!window.L){
    const link=document.createElement('link'); link.rel='stylesheet'; link.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(link);
    const script=document.createElement('script'); script.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload=()=>drawMap(lat1,lon1,lat2,lon2); document.head.appendChild(script); return;
  }
  if(window._map) window._map.remove();
  window._map=L.map('map',{worldCopyJump:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:6,minZoom:1, attribution:'© OpenStreetMap'}).addTo(window._map);
  L.marker([lat1,lon1]).addTo(window._map).bindPopup("Origin");
  L.marker([lat2,lon2]).addTo(window._map).bindPopup("Destination");
  L.polyline([[lat1,lon1],[lat2,lon2]],{color:'#4fb1f5',weight:3,opacity:.85}).addTo(window._map);
  window._map.fitBounds([[lat1,lon1],[lat2,lon2]],{padding:[20,20]});
}
</script>
</body>
</html>
